import{t as Xe}from"./FileSaver.min-BZJn7nhf.js";import{g as me,b as pe,a as ve}from"./request-CFRNLJUO.js";import{c as Ye}from"./user-zsvvfW3I.js";import{f as et}from"./date-BJiIg-Wo.js";import{u as tt}from"./useForm-F-BTzaOj.js";import{u as lt}from"./useToast-COV4_F9C.js";import{_ as at,r as a,U as O,e as L,B as ot,g as de,w as n,f as c,a as W,b as r,i as u,h as s,t as p,u as st,c as ce,F as nt,k as it,q as h}from"./index-DSMUlJua.js";function rt(g){return me("/api/v1/back_stage/notice/list",g)}function ut(g){return pe("/api/v1/back_stage/notice/add",g).then(i=>{if(!i)throw new Error("请求失败，未返回响应数据");return i})}function dt(g,i){return ve(`/api/v1/back_stage/notice/modify?id=${g}`,i).then(b=>{if(!b)throw new Error("请求失败，未返回响应数据");return b})}function ct(g){return ve(`/api/v1/back_stage/notice/delete?id=${g}`).then(i=>{if(!i)throw new Error("请求失败，未返回响应数据");return i})}function mt(g){return pe("/api/v1/back_stage/notice/push",g).then(i=>{if(!i)throw new Error("请求失败，未返回响应数据");return i})}function pt(){return me("/api/v1/back_stage/notice/type")}const vt={class:"mb-4"},gt={class:"filters-row"},ft={class:"table-responsive"},bt=["title"],Vt={class:"action-container"},_t={class:"flex justify-end gap-4"},yt={class:"dialog-header"},wt={class:"dialog-content"},kt={class:"version-info"},xt={class:"system-highlight"},ht={class:"system-highlight"},Dt={class:"dialog-header"},Ct={class:"modal-content"},Ut={class:"flex justify-end gap-4"},Tt={class:"flex justify-end mt-4"},zt={class:"ml-4 self-center text-gray-600"},Ft={__name:"notice",setup(g){const{init:i}=lt();tt("addFormRef");const b=a(!1);a(null),a(null);const Z=a(null),V=a(""),D=a(""),C=a(!1),y=a(""),w=a(""),k=a(""),U=a(""),T=a(""),G=a([]),H=a([]),J=a([]),ge=l=>{Z.value=l.id,b.value=!0},j=l=>l.map(e=>({value:e,text:e})),_=async()=>{try{const l=await pt(),e={value:"",text:"所有"};G.value=[e,...j(l||[])],H.value=j(l||[]);const m=await Ye();J.value=[e,...j(m||[])]}catch(l){i({message:l,color:"danger"})}},M=a(""),fe=[{value:"",text:"所有"},{value:"1",text:"已推送"},{value:"0",text:"未推送"}],K=()=>y.value.trim().length,Q=()=>w.value.trim().length,X=()=>k.value.trim().length,Y=()=>K()>0&&K()<=50&&Q()>0&&Q()<=100&&X()>0&&X()<=2e3&&U.value!=""&&T.value!="",be=()=>(console.log("title length is",o.title.trim().length),o.title.trim().length>0&&o.title.trim().length<=50&&o.spec.trim().length>0&&o.spec.trim().length<=100&&o.content.trim().length>0&&o.content.trim().length<=2e3&&o.belonged_user.value!=""&&o.type.value!=""),ee=()=>{y.value="",w.value="",k.value="",U.value="",T.value=""},Ve=async()=>{if(!Y()){i({message:"请检查输入内容是否符合要求",color:"danger"});return}const l={title:y.value,title_en:y.value,spec:w.value,spec_en:w.value,content:k.value,content_en:k.value,type:T.value.value,belonged_user:U.value.value};try{await ut(l),C.value=!1,f(),ee(),i({message:"新增成功",color:"rgb(47, 148, 172)"})}catch(e){i({message:`删除失败: ${e.message||"未知错误"}`,color:"danger"})}finally{}},_e=()=>{ee(),C.value=!1},ye=async()=>{try{await ct(Z.value),i({message:"删除成功",color:"rgb(47, 148, 172)"})}catch(l){i({message:`删除失败: ${l.message||"未知错误"}`,color:"danger"})}finally{f(),_(),b.value=!1}},we=()=>{i({message:"已取消删除",color:"info"}),b.value=!1};a({}),a({}),O({});const ke=a([{value:"",text:"所有"},{value:"ios",text:"IOS"},{value:"android",text:"Android"}]);a([{value:"ios",text:"IOS"},{value:"android",text:"Android"}]);const P=a(ke[0]);a();const z=a(new Date),S=a(new Date),$=a(!1);a(new Date);const xe=a({}),he=l=>!!l||"必须选择时间",De=l=>{const e=new Date;return new Date(l)<=e?"时间必须晚于当前":!0},te=O({version:"",system:""}),Ce=L(()=>he(S.value)===!0&&De(z.value)===!0);L(()=>["0",0].includes(xe.value.is_latest));const E=a(1),F=a(0),R=a([]),le=a(!1),ae=a(0),I=a(!1);a(null),a(null),a(null),a(null);const A=a(""),oe=a(""),Ue=l=>{ae.value=l.rowData.id,A.value=l.rowData.belonged_user,oe.value=l.rowData.type,I.value=!0},Te=async l=>{const e={uid:A.value,notice_id:ae.value};try{const m=await mt(e);i({message:m,color:"success"}),await f(),await _()}catch(m){i({message:m.message||"发布失败",color:"danger"})}finally{I.value=!1}},ze=async()=>{const l=S.value;l.setHours(z.value.getHours()),l.setMinutes(z.value.getMinutes()),l.setSeconds(0);const e={version:te.version,system:te.system,release_time:l.toLocaleString()};try{await Ee(e)}catch{}finally{$.value=!1}},Fe=()=>{I.value=!1},Ie=l=>l?/^v\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?$/.test(l)||"格式示例：v1.0.0 或 v2.3.4-beta":"版本号不能为空",Ne=l=>{if(!l)return"下载链接不能为空";try{return new URL(l),!0}catch{return"请输入有效的URL地址"}};L(()=>(console.log("version is",B.version),console.log("download_url is",B.download_url),Ie(B.version)===!0&&Ne(B.download_url)===!0));const x=O({page:1,pagesize:15});a(!1),a(!1);const B=O({version:"",system:"",download_url:"",release_notes:"",release_notes_en:""}),Oe=()=>{C.value=!0},Me=(l,e)=>l?l.length>e?l.slice(0,e)+"...":l:"",f=async()=>{var l,e,m;le.value=!0;try{const v={page:x.page,pagesize:x.pagesize,content:V==null?void 0:V.value,type:(l=D.value)==null?void 0:l.value,is_published:(e=M.value)==null?void 0:e.value};P&&(v.system=(m=P.value)==null?void 0:m.value);const d=await rt(v);d!=null&&d.notices?(R.value=d.notices,F.value=d.total):(R.value=[],F.value=0)}catch(v){console.error("获取数据失败:",v),i({message:v.message||"获取数据失败",color:"danger"}),R.value=[],F.value=0}finally{le.value=!1}};ot([P,V,D,M],()=>{x.page=1,E.value=1,f(),_()});const Pe=[{key:"id",label:"序号"},{key:"type",label:"通知类型"},{key:"title",label:"标题"},{key:"spec",label:"概览"},{key:"belonged_user",label:"推送用户"},{key:"created_time",label:"通知时间"},{key:"is_published",label:"推送状态"},{key:"actions",label:"操作"}],N=a(!1),o=O({id:null,title:"",title_en:"",spec:"",spec_en:"",type:"",content:"",content_en:"",belonged_user:""}),Se=l=>{o.id=l.rowData.id,o.title=l.rowData.title,o.spec=l.rowData.spec,o.type=l.rowData.type,o.content=l.rowData.content,o.belonged_user=l.rowData.belonged_user,N.value=!0},$e=async()=>{if(!be()){i({message:"请检查输入内容是否符合要求",color:"danger"});return}const l={title:o.title,title_en:o.title,spec:o.spec,spec_en:o.spec,type:o.type.value,content:o.content,content_en:o.content_en,belonged_user:o.belonged_user};try{const e=await dt(o.id,l);N.value=!1,f(),i({message:e,color:"success"})}catch(e){i({message:e.message||"修改失败",color:"danger"})}finally{}},Ee=async l=>{try{const e=await Xe(l);i({message:e,color:"success",duration:3e4}),await f(),_()}catch(e){i({message:e.message||"定时发布失败",color:"danger",duration:5e3})}},Re=()=>{N.value=!1,Be()},Ae=()=>{$.value=!1},Be=()=>{o.version="",o.system="",o.download_url="",o.release_notes="",o.release_notes_en=""},We=l=>{x.page=Math.ceil(l/x.pagesize),E.value=l,f(),_()},He=()=>{P.value="",V.value="",D.value="",f(),_()};return f(),_(),(l,e)=>{const m=c("va-input"),v=c("va-select"),d=c("va-button"),se=c("va-button-group"),je=c("VaDataTable"),qe=c("VaInput"),ne=c("VaTextarea"),Le=c("VaForm"),q=c("va-modal"),Ze=c("VaDateInput"),Ge=c("VaTimeInput"),ie=c("va-icon"),Je=c("va-divider"),re=c("VaModal"),Ke=c("VaPagination"),Qe=c("va-card");return W(),de(Qe,{class:"machines-list"},{default:n(()=>[r("div",vt,[r("div",gt,[e[23]||(e[23]=u(" 内容查询： ")),s(m,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=t=>V.value=t),placeholder:"请输入消息内容",class:"mb-1 mr-6",style:{maxWidth:"13%"}},{prepend:n(()=>e[20]||(e[20]=[])),_:1},8,["modelValue"]),e[24]||(e[24]=u(" 类型筛选： ")),s(v,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=t=>D.value=t),options:G.value,placeholder:"请选择通知类型",class:"mb-1 mr-6",style:{maxWidth:"16%"}},null,8,["modelValue","options"]),e[25]||(e[25]=u(" 推送状态： ")),s(v,{modelValue:M.value,"onUpdate:modelValue":e[2]||(e[2]=t=>M.value=t),options:fe,placeholder:"请选择通知类型",class:"mb-1",style:{maxWidth:"16%"}},null,8,["modelValue"]),s(d,{onClick:Oe,color:"rgb(47, 148, 172)",class:"mb-1 ml-6"},{default:n(()=>e[21]||(e[21]=[u(" 新增通知 ")])),_:1}),s(d,{onClick:He,color:"rgb(47, 148, 172)",class:"mb-1 ml-6"},{default:n(()=>e[22]||(e[22]=[u(" 重置 ")])),_:1})])]),r("div",ft,[s(je,{items:R.value,columns:Pe,striped:"",class:"responsive-table"},{"cell(created_time)":n(({value:t})=>[u(p(st(et)(t)),1)]),"cell(spec)":n(({value:t})=>[t?(W(),ce("a",{key:1,title:t,target:"_blank"},p(Me(t,45)),9,bt)):(W(),ce(nt,{key:0},[u("无")],64))]),"cell(belonged_user)":n(({value:t})=>[u(p(t===""?"所有":t),1)]),"cell(is_published)":n(({value:t})=>[u(p(t==="0"?"未推送":"已推送"),1)]),"cell(actions)":n(({row:t})=>[r("div",Vt,[s(se,null,{default:n(()=>[s(d,{size:"small",icon:"edit",color:"rgb(47, 148, 172)",onClick:ue=>Se(t),title:"修改通知内容",class:"action-icon"},null,8,["onClick"]),t.rowData.is_published===0?(W(),de(d,{key:0,icon:"rocket_launch",size:"small",color:"rgb(47, 148, 172)",title:"推送",onClick:ue=>Ue(t),class:"action-icon"},null,8,["onClick"])):it("",!0),s(d,{size:"small",icon:"delete",color:"rgb(208, 24, 39)",title:"删除通知",onClick:ue=>ge(t.rowData),class:"action-icon"},null,8,["onClick"])]),_:2},1024)])]),_:1},8,["items"]),s(q,{modelValue:N.value,"onUpdate:modelValue":e[7]||(e[7]=t=>N.value=t),"hide-default-actions":"",title:"修改通知","ok-props":{color:"rgb(47, 148, 172)",textColor:"white"},"cancel-props":{color:"rgb(47, 148, 172)",textColor:"white"}},{default:n(()=>[s(Le,null,{default:n(()=>[s(v,{modelValue:o.type,"onUpdate:modelValue":e[3]||(e[3]=t=>o.type=t),options:H.value,label:"通知类型",placeholder:"请选择通知类型",class:"mb-4"},null,8,["modelValue","options"]),s(qe,{modelValue:o.title,"onUpdate:modelValue":e[4]||(e[4]=t=>o.title=t),label:"标题",class:"mb-4","max-length":50,counter:""},{counter:n(({valueLength:t})=>[r("span",{class:h({"text-danger":t>50})},p(t)+"/50 ",3)]),_:1},8,["modelValue"]),s(m,{modelValue:o.spec,"onUpdate:modelValue":e[5]||(e[5]=t=>o.spec=t),label:"概述",class:"mb-4","max-length":100,counter:""},{counter:n(({valueLength:t})=>[r("span",{class:h({"text-danger":t>100})},p(t)+"/100 ",3)]),_:1},8,["modelValue"]),s(ne,{modelValue:o.content,"onUpdate:modelValue":e[6]||(e[6]=t=>o.content=t),label:"内容 (支持HTML语言)",placeholder:"请输入详细内容...",autosize:"","min-rows":10,"max-rows":20,"max-length":2e3,counter:"",class:"mb-6",style:{width:"1000px"}},{counter:n(({valueLength:t})=>[r("span",{class:h({"text-danger":t>2e3})},p(t)+"/2000 ",3)]),_:1},8,["modelValue"])]),_:1}),r("div",_t,[s(d,{color:"secondary",onClick:Re},{default:n(()=>e[26]||(e[26]=[u(" 取消 ")])),_:1}),s(d,{onClick:$e},{default:n(()=>e[27]||(e[27]=[u(" 确认修改 ")])),_:1})])]),_:1},8,["modelValue"]),s(q,{modelValue:$.value,"onUpdate:modelValue":e[10]||(e[10]=t=>$.value=t),"hide-default-actions":"",title:"选择发布时间"},{default:n(()=>[s(Ze,{modelValue:S.value,"onUpdate:modelValue":e[8]||(e[8]=t=>S.value=t)},null,8,["modelValue"]),s(Ge,{modelValue:z.value,"onUpdate:modelValue":e[9]||(e[9]=t=>z.value=t),class:"ml-2"},null,8,["modelValue"]),s(se,null,{default:n(()=>[s(d,{block:"",onClick:Ae,color:"rgb(47, 148, 172)",class:"mt-4"},{default:n(()=>e[28]||(e[28]=[u(" 取消 ")])),_:1}),s(d,{block:"",onClick:ze,disabled:!Ce.value,color:"rgb(47, 148, 172)",class:"mt-4 ml-2"},{default:n(()=>e[29]||(e[29]=[u(" 确认发布 ")])),_:1},8,["disabled"])]),_:1})]),_:1},8,["modelValue"]),s(re,{modelValue:I.value,"onUpdate:modelValue":e[11]||(e[11]=t=>I.value=t),title:"系统提示","ok-text":"确认推送","cancel-text":"暂不推送",onOk:Te,onCancel:Fe},{header:n(()=>[r("div",yt,[s(ie,{name:"warning",color:"warning"}),e[30]||(e[30]=r("span",{class:"header-text"},"消息推送确认",-1))])]),default:n(()=>[r("div",wt,[r("p",kt,[e[31]||(e[31]=u(" 即将为 ")),r("span",xt,p(A.value===""?"所有":A.value),1),e[32]||(e[32]=u(" 用户推送 ")),r("span",ht,p(oe.value),1),e[33]||(e[33]=u(" 类型通知 "))]),s(Je)])]),_:1},8,["modelValue"]),s(re,{modelValue:b.value,"onUpdate:modelValue":e[12]||(e[12]=t=>b.value=t),title:"系统提示",size:"small",message:l.deleteConfirmMessage,onOk:ye,onCancel:we,"ok-text":"确认","cancel-text":"取消","ok-props":{color:"danger"}},{header:n(()=>[r("div",Dt,[s(ie,{name:"warning",color:"warning"}),e[34]||(e[34]=r("span",{class:"header-text"},"确认删除？",-1))])]),_:1},8,["modelValue","message"]),s(q,{modelValue:C.value,"onUpdate:modelValue":e[18]||(e[18]=t=>C.value=t),"hide-default-actions":"",size:"medium"},{header:n(()=>e[35]||(e[35]=[r("h5",{class:"va-h5"},"新增通知",-1)])),default:n(()=>[r("div",Ct,[s(m,{modelValue:y.value,"onUpdate:modelValue":e[13]||(e[13]=t=>y.value=t),label:"标题",placeholder:"请输入标题...",class:"mb-4","max-length":50,counter:""},{counter:n(({valueLength:t})=>[r("span",{class:h({"text-danger":t>50})},p(t)+"/50 ",3)]),_:1},8,["modelValue"]),s(v,{modelValue:T.value,"onUpdate:modelValue":e[14]||(e[14]=t=>T.value=t),options:H.value,label:"通知类型",placeholder:"请选择通知类型",class:"mb-4",style:{maxWidth:"47.5%"}},null,8,["modelValue","options"]),s(v,{modelValue:U.value,"onUpdate:modelValue":e[15]||(e[15]=t=>U.value=t),options:J.value,label:"用户UID",placeholder:"请选择用户UID",class:"mb-4 ml-8",style:{maxWidth:"47.5%"}},null,8,["modelValue","options"]),s(m,{modelValue:w.value,"onUpdate:modelValue":e[16]||(e[16]=t=>w.value=t),label:"概述",placeholder:"请输入概述...",class:"mb-4","max-length":100,counter:""},{counter:n(({valueLength:t})=>[r("span",{class:h({"text-danger":t>100})},p(t)+"/100 ",3)]),_:1},8,["modelValue"]),s(ne,{modelValue:k.value,"onUpdate:modelValue":e[17]||(e[17]=t=>k.value=t),label:"内容 (支持HTML语言)",placeholder:"请输入详细内容...",autosize:"","min-rows":10,"max-rows":20,"max-length":2e3,counter:"",class:"mb-6",style:{width:"1000px"}},{counter:n(({valueLength:t})=>[r("span",{class:h({"text-danger":t>2e3})},p(t)+"/2000 ",3)]),_:1},8,["modelValue"]),r("div",Ut,[s(d,{color:"secondary",onClick:_e},{default:n(()=>e[36]||(e[36]=[u(" 取消 ")])),_:1}),s(d,{disabled:!Y,onClick:Ve},{default:n(()=>e[37]||(e[37]=[u(" 确认新增 ")])),_:1},8,["disabled"])])])]),_:1},8,["modelValue"])]),r("div",Tt,[s(Ke,{modelValue:E.value,"onUpdate:modelValue":[e[19]||(e[19]=t=>E.value=t),We],"page-size":x.pagesize,"visible-pages":"5",total:F.value,"buttons-preset":"secondary","boundary-numbers":""},null,8,["modelValue","page-size","total"]),r("span",zt," 共 "+p(F.value)+" 条记录 ",1)])]),_:1})}}},Et=at(Ft,[["__scopeId","data-v-300540de"]]);export{Et as default};
//# sourceMappingURL=notice-Bd9_i8LJ.js.map
