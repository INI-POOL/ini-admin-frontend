import{g as ie,p as me,a as ve}from"./allocate-BaQ0qgED.js";import{m as pe}from"./machines-BWdRLeE2.js";import{g as L,d as _e,c as X,i as fe}from"./date-Cf0mn9XG.js";import{u as ge}from"./useToast-CeymsjVO.js";import{_ as ye,r as u,U as A,B as be,g as y,w as a,X as ke,f as d,a as b,b as c,h as o,u as E,i as n,t as v,k as D,I as De,Y as G}from"./index-4vImWgGE.js";import"./request-CQdeecyZ.js";const Ve={class:"mb-4"},we={class:"mb-4"},xe={class:"table-responsive"},Ce={class:"space-y-4"},Te={class:"grid grid-cols-2 gap-4"},Se={class:"flex justify-end mt-4"},ze={class:"ml-4 self-center text-gray-600"},Ue={__name:"pre_alloc",setup(he){const H=ke(),{init:p}=ge(),k=u(L(8)),V=u(""),P=u([]);u([{value:"hashrate",text:"算力"},{value:"time",text:"时长"}]);const i=u(""),U=u(!1),w=l=>new Promise(e=>setTimeout(e,l)),J=()=>{p({message:"",color:"success",duration:5e4,render:()=>G("div",["分配成功，",G("a",{href:"javascript:void(0);",style:"color: #fff; text-decoration: underline;",onClick:()=>K()},"请前往分配记录查看")])})},K=()=>{H.push({name:"allocated"})},h=A({}),F=u(1),x=u(0),C=u([]),$=u(!1),B=u(null),T=A({page:1,pagesize:15,date:new Date().toISOString().split("T")[0],currency:"aleo"}),I=u(!1),O=u(!1),g=u(null);let Y=[{key:"uid",label:"用户UID"},{key:"sub_user_name",label:"子账户名"},{key:"machines",label:"机器数"},{key:"day_profits",label:"分配收益 "},{key:"fees",label:"手续费 "},{key:"currency",label:"币种"}];const j=l=>{B.value=l,O.value=!0},Q=l=>{if(!l)return"";const e=new Date(l),r=e.getFullYear(),f=String(e.getMonth()+1).padStart(2,"0"),_=String(e.getDate()).padStart(2,"0");return`${r}-${f}-${_}`},M=async(l,e)=>{Y=_e(l.rowData.currency),$.value=!0,console.log("record_date is",l.rowData.record_date);try{const r={date:X(l.rowData.record_date),currency:l.rowData.currency,group:l.rowData.group,alloc_type:e||"hashrate"},f=await me(r);g.value=f,I.value=!0}catch(r){p({message:r,color:"danger"})}finally{$.value=!1}},Z=async(l,e)=>{U.value=!0;let r=De();if(!h.google_code){p({message:"谷歌认证码不能为空",color:"danger"});return}try{const f={date:X(l.rowData.record_date),currency:l.rowData.currency,group:l.rowData.group,alloc_type:e,user_name:r,google_code:h.google_code};i.value="正在校验参数...",p({message:i.value,color:"info",duration:5e3}),await w(2e3);const _=await ve(f);i.value="正在确认分配任务...",p({message:i.value,color:"info",duration:3e3}),await w(2e3),i.value="正在检查机器运行情况...",p({message:i.value,color:"info",duration:3e3}),await w(2e3),i.value="正在检查节点收益...",p({message:i.value,color:"info",duration:3e3}),await w(2e3),i.value="开始分配...",p({message:i.value,color:"info",duration:5e3}),await w(5e3),_==="分币成功"?(i.value="分配成功，请前往分配记录查看",J()):p({message:_,color:"danger",duration:5e4})}catch(f){p({message:f||"获取数据失败",color:"info"})}finally{U.value=!1,z(),S()}},ee=l=>l.map(e=>({value:e,text:e})),S=async()=>{try{const l=await pe(),e={value:"",text:"所有"};P.value=[e,...ee(l.currencies||[])]}catch(l){console.error("接口调用失败:",l)}},z=async()=>{var l;$.value=!0;try{const e={date:T.date,currency:(l=V.value)==null?void 0:l.value};k.value&&(e.date=Q(k.value));const r=await ie(e);r!=null&&r.tasks?(C.value=r.tasks,console.log(C.value),x.value=r.total):(C.value=[],x.value=0)}catch(e){console.error("获取数据失败:",e),p({message:e.message||"获取数据失败",color:"danger"}),C.value=[],x.value=0}finally{$.value=!1}};be([k,V],()=>{T.page=1,F.value=1,z(),S()});const ae={0:"未开始",1:"已完成",2:"已失败"},te=[{key:"id",label:"ID"},{key:"record_date",label:"日期"},{key:"currency",label:"币种"},{key:"group",label:"组名"},{key:"status",label:"状态"},{key:"actions",label:"分配"}];u(!1),A({id:null,real_power:"",real_reward:"",need_allocate:""});const le=l=>{T.page=Math.ceil(l/T.pagesize),F.value=l,z(),S()},oe=()=>{k.value=L(8),V.value="",z(),S()};return z(),S(),(l,e)=>{const r=d("va-date-input"),f=d("va-select"),_=d("va-button"),se=d("va-progress-bar"),ne=d("va-button-group"),re=d("VaInput"),R=d("va-modal"),m=d("va-text"),W=d("va-card-content"),N=d("va-card"),ue=d("va-card-title"),q=d("VaDataTable"),ce=d("va-loading"),de=d("VaPagination");return b(),y(N,{class:"machines-list"},{default:a(()=>[c("div",Ve,[o(r,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=t=>k.value=t),placeholder:"选择日期",class:"mb-1 mr-8",style:{maxWidth:"12%"},"allowed-days":t=>!E(fe)(t)},null,8,["modelValue","allowed-days"]),o(f,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=t=>V.value=t),options:P.value,placeholder:"币种筛选",class:"mb-1 mr-5",style:{maxWidth:"12%"}},null,8,["modelValue","options"]),o(_,{onClick:oe,class:"ml-5",color:"rgb(47, 148, 172)"},{default:a(()=>e[7]||(e[7]=[n(" 刷新 ")])),_:1})]),c("div",we,[o(se,{indeterminate:U.value,label:i.value,color:"primary",class:"mb-2"},null,8,["indeterminate","label"])]),c("div",xe,[o(q,{items:C.value,columns:te,striped:"",class:"responsive-table"},{"cell(record_date)":a(({value:t})=>[n(v(t?t.split("T")[0]:""),1)]),"cell(need_allocate)":a(({value:t})=>[n(v(t===1?"是":"否"),1)]),"cell(status)":a(({value:t})=>[n(v(ae[t]),1)]),"cell(actions)":a(({row:t})=>[o(ne,null,{default:a(()=>[t.rowData.currency!="tao"&&t.rowData.currency!="ltc"?(b(),y(_,{key:0,size:"medium",color:"rgb(47, 148, 172)",class:"mr-4",onClick:s=>M(t,"hashrate")},{default:a(()=>e[8]||(e[8]=[n("模拟 (算力)")])),_:2},1032,["onClick"])):D("",!0),t.rowData.currency!="tao"&&t.rowData.currency!="ltc"?(b(),y(_,{key:1,size:"medium",color:"rgb(47, 148, 172)",class:"mr-4",onClick:s=>M(t,"time")},{default:a(()=>e[9]||(e[9]=[n("模拟 (时长)")])),_:2},1032,["onClick"])):D("",!0),t.rowData.currency!="tao"&&t.rowData.currency!="ltc"?(b(),y(_,{key:2,size:"medium",disabled:t.rowData.status===1,color:"danger",class:"mr-4",onClick:s=>j(t)},{default:a(()=>e[10]||(e[10]=[n("实际分配 (算力)")])),_:2},1032,["disabled","onClick"])):D("",!0),t.rowData.currency==="tao"||t.rowData.currency==="ltc"?(b(),y(_,{key:3,size:"medium",color:"rgb(47, 148, 172)",class:"mr-4",onClick:s=>M(t,"")},{default:a(()=>e[11]||(e[11]=[n("模拟分配")])),_:2},1032,["onClick"])):D("",!0),t.rowData.currency==="tao"||t.rowData.currency==="ltc"?(b(),y(_,{key:4,size:"medium",disabled:t.rowData.status===1,color:"danger",class:"mr-4",onClick:s=>j(t)},{default:a(()=>e[12]||(e[12]=[n("实际分配")])),_:2},1032,["disabled","onClick"])):D("",!0)]),_:2},1024),o(R,{modelValue:O.value,"onUpdate:modelValue":e[3]||(e[3]=s=>O.value=s),title:"实际分配 (算力)","ok-text":"确认","cancel-text":"取消",size:"small",class:"audit-modal",onOk:e[4]||(e[4]=s=>Z(B.value,"hashrate"))},{default:a(()=>[c("div",Ce,[c("div",null,[e[13]||(e[13]=c("div",{class:"mb-2",style:{"padding-top":"0.62rem"}},"谷歌认证",-1)),o(re,{modelValue:h.google_code,"onUpdate:modelValue":e[2]||(e[2]=s=>h.google_code=s),width:"200px",placeholder:"请输入谷歌认证码"},null,8,["modelValue"])])])]),_:1},8,["modelValue"]),o(R,{modelValue:I.value,"onUpdate:modelValue":e[5]||(e[5]=s=>I.value=s),title:"模拟分配数据"},{default:a(()=>[o(N,{class:"mb-4"},{default:a(()=>[o(W,null,{default:a(()=>[c("div",Te,[c("div",null,[o(m,{class:"font-bold"},{default:a(()=>e[14]||(e[14]=[n("分配日期：")])),_:1}),o(m,null,{default:a(()=>[n(v(g.value.record_date),1)]),_:1})]),c("div",null,[o(m,{class:"font-bold"},{default:a(()=>e[15]||(e[15]=[n("总机器数：")])),_:1}),o(m,null,{default:a(()=>[n(v(g.value.total_machines),1)]),_:1})]),c("div",null,[o(m,{class:"font-bold"},{default:a(()=>e[16]||(e[16]=[n("币种：")])),_:1}),o(m,null,{default:a(()=>{var s;return[n(v(((s=g.value.currency)==null?void 0:s.toUpperCase())||"Unknown"),1)]}),_:1})]),c("div",null,[o(m,{class:"font-bold"},{default:a(()=>e[17]||(e[17]=[n("总分配收益：")])),_:1}),o(m,null,{default:a(()=>{var s;return[n(v((s=g.value.total_alloc_profits)==null?void 0:s.toFixed(6)),1)]}),_:1})]),c("div",null,[o(m,{class:"font-bold"},{default:a(()=>e[18]||(e[18]=[n("节点收益：")])),_:1}),o(m,null,{default:a(()=>{var s;return[n(v((s=g.value.total_profits)==null?void 0:s.toFixed(6)),1)]}),_:1})]),c("div",null,[o(m,{class:"font-bold"},{default:a(()=>e[19]||(e[19]=[n("总手续费：")])),_:1}),o(m,null,{default:a(()=>{var s;return[n(v((s=g.value.total_fees)==null?void 0:s.toFixed(6)),1)]}),_:1})])])]),_:1})]),_:1}),o(N,null,{default:a(()=>[o(ue,null,{default:a(()=>e[20]||(e[20]=[n("用户分配详情")])),_:1}),o(W,null,{default:a(()=>[o(q,{items:g.value.user_alloc_detail,columns:E(Y),striped:"",hoverable:""},{"cell(day_profits)":a(({value:s})=>[n(v(parseFloat(s).toFixed(6)),1)]),"cell(fees)":a(({value:s})=>[n(v(parseFloat(s).toFixed(6)),1)]),_:1},8,["items","columns"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["items"]),U.value?(b(),y(ce,{key:0,message:i.value},null,8,["message"])):D("",!0)]),c("div",Se,[o(de,{modelValue:F.value,"onUpdate:modelValue":[e[6]||(e[6]=t=>F.value=t),le],"page-size":T.pagesize,"visible-pages":"5",total:x.value,"buttons-preset":"secondary","boundary-numbers":""},null,8,["modelValue","page-size","total"]),c("span",ze," 共 "+v(x.value)+" 条记录 ",1)])]),_:1})}}},Ae=ye(Ue,[["__scopeId","data-v-6e0487e0"]]);export{Ae as default};
//# sourceMappingURL=pre_alloc-DXsPIcTN.js.map
