import{g as ue,p as de,a as ce}from"./allocate-DDZpP4aZ.js";import{m as ie}from"./machines-CxKHgJf4.js";import{g as me,c as j,i as ve}from"./date-3l_ArPo2.js";import{u as pe}from"./useToast-DY2oWFKw.js";import{_ as _e,r as u,U as I,B as fe,g as R,w as a,W as ge,f as c,a as Y,b as d,i as s,h as l,u as ye,t as v,k as be,I as ke,X as q}from"./index-LkJVCUGy.js";import"./request-CXVB8vf5.js";const Ve={class:"mb-4"},De={class:"mb-4"},we={class:"table-responsive"},xe={class:"space-y-4"},Ce={class:"grid grid-cols-2 gap-4"},Te={class:"flex justify-end mt-4"},Se={class:"ml-4 self-center text-gray-600"},he={__name:"pre_alloc",setup(Ue){const L=ge(),{init:p}=pe(),y=u(me(8)),C=u(""),M=u([]);u([{value:"hashrate",text:"算力"},{value:"time",text:"时长"}]);const i=u(""),T=u(!1),b=t=>new Promise(e=>setTimeout(e,t)),X=()=>{p({message:"",color:"success",duration:5e4,render:()=>q("div",["分配成功，",q("a",{href:"javascript:void(0);",style:"color: #fff; text-decoration: underline;",onClick:()=>E()},"请前往分配记录查看")])})},E=()=>{L.push({name:"allocated"})},S=I({}),h=u(1),k=u(0),V=u([]),U=u(!1),$=u(null),D=I({page:1,pagesize:15,date:new Date().toISOString().split("T")[0],currency:"aleo"}),z=u(!1),F=u(!1),g=u(null),G=[{key:"uid",label:"用户UID"},{key:"sub_user_name",label:"子账户名"},{key:"machines",label:"机器数"},{key:"day_profits",label:"分配收益 "},{key:"fees",label:"手续费 "}],H=t=>{$.value=t,F.value=!0},J=t=>{if(!t)return"";const e=new Date(t),r=e.getFullYear(),_=String(e.getMonth()+1).padStart(2,"0"),f=String(e.getDate()).padStart(2,"0");return`${r}-${_}-${f}`},N=async(t,e)=>{U.value=!0,console.log("record_date is",t.rowData.record_date);try{const r={date:j(t.rowData.record_date),currency:t.rowData.currency,group:t.rowData.group,alloc_type:e||"hashrate"},_=await de(r);g.value=_,z.value=!0}catch(r){p({message:r,color:"danger"})}finally{U.value=!1}},K=async(t,e)=>{T.value=!0;let r=ke();if(!S.google_code){p({message:"谷歌认证码不能为空",color:"danger"});return}try{const _={date:j(t.rowData.record_date),currency:t.rowData.currency,group:t.rowData.group,alloc_type:e,user_name:r,google_code:S.google_code};i.value="正在校验参数...",p({message:i.value,color:"info",duration:5e3}),await b(2e3);const f=await ce(_);i.value="正在确认分配任务...",p({message:i.value,color:"info",duration:3e3}),await b(2e3),i.value="正在检查机器运行情况...",p({message:i.value,color:"info",duration:3e3}),await b(2e3),i.value="正在检查节点收益...",p({message:i.value,color:"info",duration:3e3}),await b(2e3),i.value="开始分配...",p({message:i.value,color:"info",duration:5e3}),await b(5e3),f==="分币成功"?(i.value="分配成功，请前往分配记录查看",X()):p({message:f,color:"danger",duration:5e4})}catch(_){p({message:_||"获取数据失败",color:"info"})}finally{T.value=!1,x(),w()}},A=t=>t.map(e=>({value:e,text:e})),w=async()=>{try{const t=await ie(),e={value:"",text:"所有"};M.value=[e,...A(t.currencies||[])],groupOptions.value=[e,...A(t.groups||[])]}catch(t){console.error("接口调用失败:",t)}},x=async()=>{var t;U.value=!0;try{const e={date:D.date,currency:(t=C.value)==null?void 0:t.value};y.value&&(e.date=J(y.value));const r=await ue(e);r!=null&&r.tasks?(V.value=r.tasks,console.log(V.value),k.value=r.total):(V.value=[],k.value=0)}catch(e){console.error("获取数据失败:",e),p({message:e.message||"获取数据失败",color:"danger"}),V.value=[],k.value=0}finally{U.value=!1}};fe([y,C],()=>{D.page=1,h.value=1,x(),w()});const Q={0:"未开始",1:"已完成",2:"已失败"},Z=[{key:"id",label:"ID"},{key:"record_date",label:"日期"},{key:"currency",label:"币种"},{key:"group",label:"组名"},{key:"status",label:"状态"},{key:"actions",label:"分配"}];u(!1),I({id:null,real_power:"",real_reward:"",need_allocate:""});const ee=t=>{D.page=Math.ceil(t/D.pagesize),h.value=t,x(),w()},ae=()=>{x(),w()};return x(),w(),(t,e)=>{const r=c("va-date-input"),_=c("va-select"),f=c("va-button"),le=c("va-progress-bar"),te=c("va-button-group"),oe=c("VaInput"),P=c("va-modal"),m=c("va-text"),B=c("va-card-content"),O=c("va-card"),se=c("va-card-title"),W=c("VaDataTable"),ne=c("va-loading"),re=c("VaPagination");return Y(),R(O,{class:"machines-list"},{default:a(()=>[d("div",Ve,[e[8]||(e[8]=s(" 选择日期： ")),l(r,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=n=>y.value=n),placeholder:"选择日期",class:"mb-1 mr-5",style:{maxWidth:"20%"},"allowed-days":n=>!ye(ve)(n)},null,8,["modelValue","allowed-days"]),l(_,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=n=>C.value=n),options:M.value,placeholder:"币种筛选",class:"mb-1 mr-5",style:{maxWidth:"16%"}},null,8,["modelValue","options"]),l(f,{onClick:ae,class:"ml-5",color:"rgb(47, 148, 172)"},{default:a(()=>e[7]||(e[7]=[s(" 刷新 ")])),_:1})]),d("div",De,[l(le,{indeterminate:T.value,label:i.value,color:"primary",class:"mb-2"},null,8,["indeterminate","label"])]),d("div",we,[l(W,{items:V.value,columns:Z,striped:"",class:"responsive-table"},{"cell(record_date)":a(({value:n})=>[s(v(n?n.split("T")[0]:""),1)]),"cell(need_allocate)":a(({value:n})=>[s(v(n===1?"是":"否"),1)]),"cell(status)":a(({value:n})=>[s(v(Q[n]),1)]),"cell(actions)":a(({row:n})=>[l(te,null,{default:a(()=>[l(f,{size:"medium",color:"rgb(47, 148, 172)",class:"mr-4",onClick:o=>N(n,"hashrate")},{default:a(()=>e[9]||(e[9]=[s("模拟 (算力)")])),_:2},1032,["onClick"]),l(f,{size:"medium",color:"rgb(47, 148, 172)",class:"mr-4",onClick:o=>N(n,"time")},{default:a(()=>e[10]||(e[10]=[s("模拟 (时长)")])),_:2},1032,["onClick"]),l(f,{size:"medium",disabled:n.rowData.status===1,color:"danger",class:"mr-4",onClick:o=>H(n)},{default:a(()=>e[11]||(e[11]=[s("实际分配 (算力)")])),_:2},1032,["disabled","onClick"])]),_:2},1024),l(P,{modelValue:F.value,"onUpdate:modelValue":e[3]||(e[3]=o=>F.value=o),title:"实际分配 (算力)","ok-text":"确认","cancel-text":"取消",size:"small",class:"audit-modal",onOk:e[4]||(e[4]=o=>K($.value,"hashrate"))},{default:a(()=>[d("div",xe,[d("div",null,[e[12]||(e[12]=d("div",{class:"mb-2",style:{"padding-top":"0.62rem"}},"谷歌认证",-1)),l(oe,{modelValue:S.google_code,"onUpdate:modelValue":e[2]||(e[2]=o=>S.google_code=o),width:"200px",placeholder:"请输入谷歌认证码"},null,8,["modelValue"])])])]),_:1},8,["modelValue"]),l(P,{modelValue:z.value,"onUpdate:modelValue":e[5]||(e[5]=o=>z.value=o),title:"模拟分配数据"},{default:a(()=>[l(O,{class:"mb-4"},{default:a(()=>[l(B,null,{default:a(()=>[d("div",Ce,[d("div",null,[l(m,{class:"font-bold"},{default:a(()=>e[13]||(e[13]=[s("分配日期：")])),_:1}),l(m,null,{default:a(()=>[s(v(g.value.record_date),1)]),_:1})]),d("div",null,[l(m,{class:"font-bold"},{default:a(()=>e[14]||(e[14]=[s("总机器数：")])),_:1}),l(m,null,{default:a(()=>[s(v(g.value.total_machines),1)]),_:1})]),d("div",null,[l(m,{class:"font-bold"},{default:a(()=>e[15]||(e[15]=[s("币种：")])),_:1}),l(m,null,{default:a(()=>{var o;return[s(v(((o=n.rowData.currency)==null?void 0:o.toUpperCase())||"Unknown"),1)]}),_:2},1024)]),d("div",null,[l(m,{class:"font-bold"},{default:a(()=>e[16]||(e[16]=[s("总分配收益：")])),_:1}),l(m,null,{default:a(()=>{var o;return[s(v((o=g.value.total_alloc_profits)==null?void 0:o.toFixed(6)),1)]}),_:1})]),d("div",null,[l(m,{class:"font-bold"},{default:a(()=>e[17]||(e[17]=[s("节点收益：")])),_:1}),l(m,null,{default:a(()=>{var o;return[s(v((o=g.value.total_profits)==null?void 0:o.toFixed(6)),1)]}),_:1})]),d("div",null,[l(m,{class:"font-bold"},{default:a(()=>e[18]||(e[18]=[s("总手续费：")])),_:1}),l(m,null,{default:a(()=>{var o;return[s(v((o=g.value.total_fees)==null?void 0:o.toFixed(6)),1)]}),_:1})])])]),_:2},1024)]),_:2},1024),l(O,null,{default:a(()=>[l(se,null,{default:a(()=>e[19]||(e[19]=[s("用户分配详情")])),_:1}),l(B,null,{default:a(()=>[l(W,{items:g.value.user_alloc_detail,columns:G,striped:"",hoverable:""},{"cell(day_profits)":a(({value:o})=>[s(v(parseFloat(o).toFixed(6)),1)]),"cell(fees)":a(({value:o})=>[s(v(parseFloat(o).toFixed(6)),1)]),_:1},8,["items"])]),_:1})]),_:1})]),_:2},1032,["modelValue"])]),_:1},8,["items"]),T.value?(Y(),R(ne,{key:0,message:i.value},null,8,["message"])):be("",!0)]),d("div",Te,[l(re,{modelValue:h.value,"onUpdate:modelValue":[e[6]||(e[6]=n=>h.value=n),ee],"page-size":D.pagesize,"visible-pages":"5",total:k.value,"buttons-preset":"secondary","boundary-numbers":""},null,8,["modelValue","page-size","total"]),d("span",Se," 共 "+v(k.value)+" 条记录 ",1)])]),_:1})}}},Ne=_e(he,[["__scopeId","data-v-0bbf89f3"]]);export{Ne as default};
//# sourceMappingURL=pre_alloc-BWakRonb.js.map
