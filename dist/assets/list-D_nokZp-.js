import{g as oe,p as se,a as ne}from"./allocate-CXs8gayL.js";import{g as re,a as B,i as ue}from"./date-CMM1G54V.js";import{u as de}from"./useToast-D8MyLy3n.js";import{_ as ie,r as d,U as h,B as ce,g as O,w as a,X as me,f as c,a as Y,b as u,i as o,h as l,u as ve,t as p,k as pe,I as _e,Y as j}from"./index-CVBAPNBq.js";import"./request-CyVb8btO.js";const fe={class:"mb-4"},ge={class:"mb-4"},ye={class:"table-responsive"},be={class:"space-y-4"},ke={class:"grid grid-cols-2 gap-4"},De={class:"flex justify-end mt-4"},Ve={class:"ml-4 self-center text-gray-600"},we={__name:"list",setup(xe){const R=me(),{init:_}=de(),y=d(re(8)),$=d("");d([{value:"hashrate",text:"算力"},{value:"time",text:"时长"}]);const i=d(""),x=d(!1),b=s=>new Promise(e=>setTimeout(e,s)),q=()=>{_({message:"",color:"success",duration:5e4,render:()=>j("div",["分配成功，",j("a",{href:"javascript:void(0);",style:"color: #fff; text-decoration: underline;",onClick:()=>L()},"请前往分配记录查看")])})},L=()=>{R.push({name:"allocated"})},C=h({}),T=d(1),k=d(0),D=d([]),S=d(!1),z=d(null),V=h({page:1,pagesize:15,date:new Date().toISOString().split("T")[0],currency:"aleo"}),U=d(!1),F=d(!1),f=d(null),W=[{key:"uid",label:"用户UID"},{key:"sub_user_name",label:"子账户名"},{key:"machines",label:"机器数"},{key:"day_profits",label:"分配收益 "},{key:"fees",label:"手续费 "}],X=s=>{z.value=s,F.value=!0},E=s=>{if(!s)return"";const e=new Date(s),r=e.getFullYear(),m=String(e.getMonth()+1).padStart(2,"0"),g=String(e.getDate()).padStart(2,"0");return`${r}-${m}-${g}`},M=async(s,e)=>{S.value=!0,console.log("record_date is",s.rowData.record_date);try{const r={date:B(s.rowData.record_date),currency:s.rowData.currency,group:s.rowData.group,alloc_type:e||"hashrate"},m=await se(r);f.value=m,U.value=!0}catch(r){_({message:r,color:"danger"})}finally{S.value=!1}},G=async(s,e)=>{x.value=!0;let r=_e();if(!C.google_code){_({message:"谷歌认证码不能为空",color:"danger"});return}try{const m={date:B(s.rowData.record_date),currency:s.rowData.currency,group:s.rowData.group,alloc_type:e,user_name:r,google_code:C.google_code};i.value="正在校验参数...",_({message:i.value,color:"info",duration:5e3}),await b(2e3);const g=await ne(m);i.value="正在确认分配任务...",_({message:i.value,color:"info",duration:3e3}),await b(2e3),i.value="正在检查机器运行情况...",_({message:i.value,color:"info",duration:3e3}),await b(2e3),i.value="正在检查节点收益...",_({message:i.value,color:"info",duration:3e3}),await b(2e3),i.value="开始分配...",_({message:i.value,color:"info",duration:5e3}),await b(5e3),g==="分币成功"?(i.value="分配成功，请前往分配记录查看",q()):_({message:g,color:"danger",duration:5e4})}catch(m){_({message:m||"获取数据失败",color:"info"})}finally{x.value=!1,w()}},w=async()=>{var s;S.value=!0;try{const e={date:V.date,currency:((s=$.value)==null?void 0:s.value)||"aleo"};y.value&&(e.date=E(y.value));const r=await oe(e);r!=null&&r.tasks?(D.value=r.tasks,console.log(D.value),k.value=r.total):(D.value=[],k.value=0)}catch(e){console.error("获取数据失败:",e),_({message:e.message||"获取数据失败",color:"danger"}),D.value=[],k.value=0}finally{S.value=!1}};ce([y,$],()=>{V.page=1,T.value=1,w()});const H={0:"未开始",1:"已完成",2:"已失败"},J=[{key:"id",label:"ID"},{key:"record_date",label:"日期"},{key:"currency",label:"币种"},{key:"group",label:"组名"},{key:"status",label:"状态"},{key:"actions",label:"操作"}];d(!1),h({id:null,real_power:"",real_reward:"",need_allocate:""});const K=s=>{V.page=Math.ceil(s/V.pagesize),T.value=s,w()},Q=()=>{w()};return w(),(s,e)=>{const r=c("va-date-input"),m=c("va-button"),g=c("va-progress-bar"),Z=c("va-button-group"),ee=c("VaInput"),N=c("va-modal"),v=c("va-text"),A=c("va-card-content"),I=c("va-card"),ae=c("va-card-title"),P=c("VaDataTable"),le=c("va-loading"),te=c("VaPagination");return Y(),O(I,{class:"machines-list"},{default:a(()=>[u("div",fe,[e[7]||(e[7]=o(" 选择日期： ")),l(r,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=n=>y.value=n),placeholder:"选择日期",class:"mb-1 mr-5",style:{maxWidth:"20%"},"allowed-days":n=>!ve(ue)(n)},null,8,["modelValue","allowed-days"]),l(m,{onClick:Q,class:"ml-5"},{default:a(()=>e[6]||(e[6]=[o(" 刷新 ")])),_:1})]),u("div",ge,[l(g,{indeterminate:x.value,label:i.value,color:"primary",class:"mb-2"},null,8,["indeterminate","label"])]),u("div",ye,[l(P,{items:D.value,columns:J,striped:"",class:"responsive-table"},{"cell(record_date)":a(({value:n})=>[o(p(n?n.split("T")[0]:""),1)]),"cell(need_allocate)":a(({value:n})=>[o(p(n===1?"是":"否"),1)]),"cell(status)":a(({value:n})=>[o(p(H[n]),1)]),"cell(actions)":a(({row:n})=>[l(Z,null,{default:a(()=>[l(m,{small:"",color:"success",class:"mr-4",onClick:t=>M(n,"hashrate")},{default:a(()=>e[8]||(e[8]=[o("模拟分配 (算力)")])),_:2},1032,["onClick"]),l(m,{small:"",color:"primary",class:"mr-4",onClick:t=>M(n,"time")},{default:a(()=>e[9]||(e[9]=[o("模拟分配 (时长)")])),_:2},1032,["onClick"]),l(m,{disabled:n.rowData.status===1,small:"",color:"danger",class:"mr-4",onClick:t=>X(n)},{default:a(()=>e[10]||(e[10]=[o("实际分配 (算力)")])),_:2},1032,["disabled","onClick"])]),_:2},1024),l(N,{modelValue:F.value,"onUpdate:modelValue":e[2]||(e[2]=t=>F.value=t),title:"实际分配 (算力)","ok-text":"确认","cancel-text":"取消",size:"small",class:"audit-modal",onOk:e[3]||(e[3]=t=>G(z.value,"hashrate"))},{default:a(()=>[u("div",be,[u("div",null,[e[11]||(e[11]=u("div",{class:"mb-2",style:{"padding-top":"0.62rem"}},"谷歌认证",-1)),l(ee,{modelValue:C.google_code,"onUpdate:modelValue":e[1]||(e[1]=t=>C.google_code=t),width:"200px",placeholder:"请输入谷歌认证码"},null,8,["modelValue"])])])]),_:1},8,["modelValue"]),l(N,{modelValue:U.value,"onUpdate:modelValue":e[4]||(e[4]=t=>U.value=t),title:"模拟分配数据"},{default:a(()=>[l(I,{class:"mb-4"},{default:a(()=>[l(A,null,{default:a(()=>[u("div",ke,[u("div",null,[l(v,{class:"font-bold"},{default:a(()=>e[12]||(e[12]=[o("分配日期：")])),_:1}),l(v,null,{default:a(()=>[o(p(f.value.record_date),1)]),_:1})]),u("div",null,[l(v,{class:"font-bold"},{default:a(()=>e[13]||(e[13]=[o("总机器数：")])),_:1}),l(v,null,{default:a(()=>[o(p(f.value.total_machines),1)]),_:1})]),u("div",null,[l(v,{class:"font-bold"},{default:a(()=>e[14]||(e[14]=[o("币种：")])),_:1}),l(v,null,{default:a(()=>{var t;return[o(p(((t=n.rowData.currency)==null?void 0:t.toUpperCase())||"Unknown"),1)]}),_:2},1024)]),u("div",null,[l(v,{class:"font-bold"},{default:a(()=>e[15]||(e[15]=[o("总分配收益：")])),_:1}),l(v,null,{default:a(()=>{var t;return[o(p((t=f.value.total_alloc_profits)==null?void 0:t.toFixed(6)),1)]}),_:1})]),u("div",null,[l(v,{class:"font-bold"},{default:a(()=>e[16]||(e[16]=[o("节点收益：")])),_:1}),l(v,null,{default:a(()=>{var t;return[o(p((t=f.value.total_profits)==null?void 0:t.toFixed(6)),1)]}),_:1})]),u("div",null,[l(v,{class:"font-bold"},{default:a(()=>e[17]||(e[17]=[o("总手续费：")])),_:1}),l(v,null,{default:a(()=>{var t;return[o(p((t=f.value.total_fees)==null?void 0:t.toFixed(6)),1)]}),_:1})])])]),_:2},1024)]),_:2},1024),l(I,null,{default:a(()=>[l(ae,null,{default:a(()=>e[18]||(e[18]=[o("用户分配详情")])),_:1}),l(A,null,{default:a(()=>[l(P,{items:f.value.user_alloc_detail,columns:W,striped:"",hoverable:""},{"cell(day_profits)":a(({value:t})=>[o(p(parseFloat(t).toFixed(6)),1)]),"cell(fees)":a(({value:t})=>[o(p(parseFloat(t).toFixed(6)),1)]),_:1},8,["items"])]),_:1})]),_:1})]),_:2},1032,["modelValue"])]),_:1},8,["items"]),x.value?(Y(),O(le,{key:0,message:i.value},null,8,["message"])):pe("",!0)]),u("div",De,[l(te,{modelValue:T.value,"onUpdate:modelValue":[e[5]||(e[5]=n=>T.value=n),K],"page-size":V.pagesize,"visible-pages":"5",total:k.value,"buttons-preset":"secondary","boundary-numbers":""},null,8,["modelValue","page-size","total"]),u("span",Ve," 共 "+p(k.value)+" 条记录 ",1)])]),_:1})}}},Ie=ie(we,[["__scopeId","data-v-b27d4010"]]);export{Ie as default};
//# sourceMappingURL=list-D_nokZp-.js.map
