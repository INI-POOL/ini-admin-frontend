{"version":3,"file":"sub_user-DYu7PpHE.js","sources":["../../src/api/sub_user.js","../../src/pages/user/sub_user.vue"],"sourcesContent":["import { patch,get,post } from \"./request\";\n\n\nexport function getSubUsers(params) {\n    return get(\"/api/v1/back_stage/sub_user/list\", params);\n}\n\nexport function updateSubUserFee(subUserName, data) {\n    return patch(`/api/v1/back_stage/sub_user/modify/${subUserName}`, data);\n}","<template>\n    <va-card class=\"machines-list\">\n        <!-- 搜索和过滤区域 -->\n        <div class=\"mb-4\">\n\t\t\t<va-input v-model=\"searchUid\" label=\"用户UID\" placeholder=\"搜索用户UID\" class=\"mb-1 mr-8\" :style=\"{ maxWidth: '13%' }\">\n\t\t\t    <template #prepend>\n\t\t\t        <!-- <va-icon name=\"mobile\" /> -->\n\t\t\t    </template>\n\t\t\t</va-input>\n\t\t\t<va-input v-model=\"searchSub\" label=\"子账户\" placeholder=\"搜索子账户\" class=\"mb-1 mr-8\" :style=\"{ maxWidth: '13%' }\">\n\t\t\t    <template #prepend>\n\t\t\t        <!-- <va-icon name=\"mobile\" /> -->\n\t\t\t    </template>\n\t\t\t</va-input>\n\t\t\t<va-select\n\t\t\t\tv-model=\"searchCurrency\"\n\t\t\t\tlabel=\"币种\"\n\t\t\t\t:options=\"currencyOptions\"\n\t\t\t\tplaceholder=\"请选择币种\"\n\t\t\t\tselected-top-shown\n\t\t\t\tclass=\"filter-item mb-1 mr-8\"\n\t\t\t\t:style=\"{ maxWidth: '13%' }\"\n\t\t\t/>\n\t\t\t<va-button @click=\"refreshData\" class=\"mt-5 mr-8\" color=\"rgb(47, 148, 172)\">\n\t\t\t    <!-- <va-icon name=\"refresh\" /> -->\n\t\t\t    刷新\n\t\t\t</va-button>\n        </div>\n\n        <!-- 列表区域 -->\n        <div class=\"table-responsive\">\n            \n            <VaDataTable :items=\"sub_users\" :columns=\"columns\" striped class=\"responsive-table\">\n\t\t\t\t<template #cell(created_time)=\"{ value }\">\n\t\t\t\t    {{ timestampToFormattedTime(value) }}\n\t\t\t\t</template>\n\t\t\t\t\n\t\t\t\t<template #cell(real_rate)=\"{ rowData, rowIndex }\">\n\t\t\t\t\t<div class=\"editable-rate\">\n\t\t\t\t\t\t<template v-if=\"editMode[rowData.sub_user_name]\">\n\t\t\t\t\t\t  <VaInput\n\t\t\t\t\t\t\tv-model.number=\"percentValues[rowData.sub_user_name]\"\n\t\t\t\t\t\t\ttype=\"number\"\n\t\t\t\t\t\t\tstep=\"1\"\n\t\t\t\t\t\t\tmin=\"0\"\n\t\t\t\t\t\t\tmax=\"100\"\n\t\t\t\t\t\t\t@keyup.enter=\"saveRate(rowData)\"\n\t\t\t\t\t\t\t@blur=\"saveRate(rowData)\"\n\t\t\t\t\t\t  >\n\t\t\t\t\t\t\t<template #appendInner>\n\t\t\t\t\t\t\t  <span class=\"percent-symbol\">%</span>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t  </VaInput>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t  <span>{{ Math.round(rowData.real_rate * 100) }}%</span>\n\t\t\t\t\t\t  <VaButton\n\t\t\t\t\t\t\tpreset=\"plain\"\n\t\t\t\t\t\t\ticon=\"edit\"\n\t\t\t\t\t\t\tcolor=\"rgb(47, 148, 172)\"\n\t\t\t\t\t\t\tclass=\"ml-2\"\n\t\t\t\t\t\t\t@click=\"startEdit(rowData)\"\n\t\t\t\t\t\t  />\n\t\t\t\t\t\t</template>\n\t\t\t\t\t  </div>\n\t\t\t    </template>\n            </VaDataTable>\n        </div>\n\n        <!-- 分页 -->\n        <div class=\"flex justify-end mt-4\">\n            <VaPagination\n                v-model=\"currentStartIndex\"\n                :page-size=\"queryParams.pagesize\"\n                visible-pages=\"5\"\n                :total=\"totalItems\"\n                buttons-preset=\"secondary\"\n                boundary-numbers\n                @update:modelValue=\"handlePageChange\"\n            />\n            <span class=\"ml-4 self-center text-gray-600\">\n                共 {{ totalItems }} 条记录\n            </span>\n        </div>\n    </va-card>\n</template>\n\n<script setup>\nimport { ref, reactive,computed } from 'vue'\nimport { machineOptions } from \"../../api/machines\"\nimport { allocated } from \"../../api/allocate\"\nimport { getSubUsers, updateSubUserFee} from \"../../api/sub_user\"\nimport { convertDateTimeToDate,timestampToFormattedTime } from \"../../utils/date.ts\"\nimport { useToast } from \"vuestic-ui\"\n\nconst { init: toast } = useToast()\n\nconst editMode = ref({}) // 存储编辑状态 { [sub_user_name]: boolean }\nconst percentValues = ref({})\n\nconst startEdit = (row) => {\n  editMode.value = { ...editMode.value, [row.sub_user_name]: true }\n  percentValues.value = { \n    ...percentValues.value, \n    [row.sub_user_name]: Math.round(row.real_rate * 100)\n  }\n}\n\nconst saveRate = async (row) => {\n  try {\n    const percentValue = percentValues.value[row.sub_user_name]\n    if (percentValue < 0 || percentValue > 100) {\n      throw new Error(\"费率必须在0-100%之间\")\n    }\n\n    await updateSubUserFee(row.sub_user_name,{\n      fee: percentValue / 100\n    })\n\n    // 更新本地数据\n    row.real_rate = percentValue / 100\n    editMode.value = { ...editMode.value, [row.sub_user_name]: false }\n  } catch (error) {\n    // 错误处理...\n  }\n}\n\nconst searchCurrency = ref('aleo')\nconst currencyOptions = ref([])\n\nconst searchSub = ref('')\nconst sub_users = ref([])\n\nconst searchUid = ref('')\n\nconst currentStartIndex = ref(1)\nconst totalItems = ref(0)\n\nconst loading = ref(false)\n\n// 修改查询参数的初始化\nconst queryParams = reactive({\n    page: 1,\n    pagesize: 15,\n    currency: 'aleo'\n})\n\nconst isModalVisible = ref(false); // 控制弹出框显示\nconst apiData = ref(null); // 存储后端返回数据\n\nconst convertToOptions = (arr) => \n  arr.map(item => ({ value: item, text: item }));\nconst fetchMachineOptions = async () => {\n  try {\n    const response = await machineOptions()\n\tconst defaultOption = { value: '', text: '所有' };\n\tcurrencyOptions.value = [defaultOption, ...convertToOptions(response.currencies || [])];\n  } catch (error) {\n    console.error('接口调用失败:', error)\n    // 异常处理逻辑\n  }\n}\n\n// 修改 fetchData 方法\nconst fetchData = async () => {\n    loading.value = true\n    try {\n        const params = {\n\t\t\tpage: queryParams.page,\n\t\t\tpagesize: queryParams.pagesize,\n            currency: searchCurrency.value?.value || 'aleo',\n\t\t\tsub_user_name: searchSub?.value,\n\t\t\tuid: searchUid?.value\n        }\n        \n        const res = await getSubUsers(params)\n        if (res?.sub_users) {\n            sub_users.value = res.sub_users\n            totalItems.value = res.total\n        } else {\n            sub_users.value = []\n            totalItems.value = 0\n        }\n    } catch (error) {\n        console.error(\"获取数据失败:\", error)\n        toast({\n            message: error.message || \"获取数据失败\",\n            color: \"danger\",\n        })\n        sub_users.value = []\n        totalItems.value = 0\n    } finally {\n        loading.value = false\n    }\n}\n\n// 添加 watch 以监听搜索条件变化\nimport { watch } from 'vue'\n\nwatch([searchCurrency,searchSub,searchUid], () => {\n    queryParams.page = 1\n    currentStartIndex.value = 1\n    fetchData()\n})\n\nconst columns = [\n    { key: 'uid', label: '用户Uid' },\n\t{ key: 'sub_user_name', label: '子账户' },\n    { key: 'currency', label: '币种' },\n\t{ key: 'machines', label: '机器数' },\n    { key: 'real_rate', label: '费率(%)'},\n\t{ key: 'total_profit', label: '净收益' },\n    { key: 'total_fee', label: '手续费' },\n\t{ key: 'created_time', label: '创建时间' },\n]\n\n// 分页\nconst handlePageChange = (startIndex) => {\n    queryParams.page = Math.ceil(startIndex / queryParams.pagesize)\n    currentStartIndex.value = startIndex\n    fetchData()\n}\n\nconst refreshData = () => {\n\tsearchSub.value = ''\n\tsearchUid.value = ''\n    fetchData()\n\tfetchMachineOptions()\n}\n\n// 初始化加载数据\nfetchData()\nfetchMachineOptions()\n</script>\n\n<style scoped>\n\t\n.editable-rate {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n\n  .va-input-wrapper {\n    width: 100px;\n    position: relative;\n\n    .percent-symbol {\n      position: absolute;\n      right: 8px;\n      top: 50%;\n      transform: translateY(-50%);\n      color: var(--va-secondary);\n      pointer-events: none;\n    }\n  }\n}\n\t  \n.machines-list {\n    padding: 20px;\n}\n\n.filters-row {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 10px;\n    align-items: center;\n}\n\n.filter-item {\n    min-width: 150px;\n}\n\n.mobile-list-item {\n    padding: 10px;\n}\n\n.mobile-actions {\n    display: flex;\n    justify-content: flex-end;\n    margin-top: 10px;\n}\n\n.action-buttons {\n    display: flex;\n    gap: 0.5rem;\n    justify-content: center;\n    padding-left: 5px;\n    padding-right: 5px;\n    min-width: 40px; /* 确保按钮有足够空间 */\n  }\n\n@media (max-width: 768px) {\n    .machines-list {\n        padding: 10px;\n    }\n\n    .filter-item {\n        width: 100%;\n        min-width: unset;\n    }\n}\n\n.custom-modal .va-modal-footer {\n  display: none; /* 隐藏默认的 footer */\n}\n</style>"],"names":["getSubUsers","params","get","updateSubUserFee","subUserName","data","patch","toast","useToast","editMode","ref","percentValues","startEdit","row","saveRate","percentValue","searchCurrency","currencyOptions","searchSub","sub_users","searchUid","currentStartIndex","totalItems","loading","queryParams","reactive","convertToOptions","arr","item","fetchMachineOptions","response","machineOptions","defaultOption","error","fetchData","_a","res","watch","columns","handlePageChange","startIndex","refreshData"],"mappings":"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"}