{"version":3,"file":"list-Cwzs_yji.js","sources":["../../src/pages/machines/list.vue"],"sourcesContent":["<template>\n    <va-card class=\"machines-list\">\n        <!-- 搜索和过滤区域 -->\n        <div class=\"mb-4\">\n            <va-input v-model=\"searchMachine\" placeholder=\"搜索机器名\" class=\"mb-1 mr-5\" :style=\"{ maxWidth: '20%'}\">\n                <template #prepend>\n                    <!-- <va-icon name=\"va-calendar\" /> -->\n                </template>\n            </va-input>\n            <va-input v-model=\"searchMobile\" placeholder=\"搜索手机号\" class=\"mb-1 mr-5\" :style=\"{ maxWidth: '20%' }\">\n                <template #prepend>\n                    <!-- <va-icon name=\"mobile\" /> -->\n                </template>\n            </va-input>\n\t\t\t<va-input v-model=\"searchSubUser\" placeholder=\"搜索子账户\" class=\"mb-1 mr-5\" :style=\"{ maxWidth: '20%' }\">\n\t\t\t    <template #prepend>\n\t\t\t        <!-- <va-icon name=\"sub\" /> -->\n\t\t\t    </template>\n\t\t\t</va-input>\n\t\t\t<va-input v-model=\"searchUid\" placeholder=\"搜索用户UID\" class=\"mb-1 mr-5\" :style=\"{ maxWidth: '20%' }\">\n\t\t\t    <template #prepend>\n\t\t\t        <!-- <va-icon name=\"sub\" /> -->\n\t\t\t    </template>\n\t\t\t</va-input>\n            <div class=\"filters-row mt-4\">\n\t\t\t\t<va-select v-model=\"searchCurrency\" :options=\"currencyOptions\" placeholder=\"币种筛选\" class=\"filter-item mr-5\" :style=\"{ maxWidth: '16%' }\" />\n               <va-select v-model=\"searchIdc\" :options=\"idcOptions\" placeholder=\"机房筛选\" class=\"filter-item\" :style=\"{ maxWidth: '16%' }\" />\n                <va-button @click=\"refreshList\" class=\"ml-5\">\n                    <!-- <va-icon name=\"refresh\" /> -->\n                    搜索\n                </va-button>\n\t\t\t\t<va-button @click=\"refreshData\" class=\"ml-5\">\n\t\t\t\t    <!-- <va-icon name=\"refresh\" /> -->\n\t\t\t\t    刷新\n\t\t\t\t</va-button>\n            </div>\n        </div>\n\n        <!-- 列表区域 -->\n        <div class=\"table-responsive\">\n            <!-- 桌面端显示表格 -->\n            <VaDataTable :items=\"machines\" :columns=\"columns\" striped  class=\"responsive-table\">\n                <!-- 时间显示 -->\n                <template #cell(created_time)=\"{ value }\">\n                    {{ formatDateTime(value) }}\n                </template>\n\t\t\t\t<template #cell(last_seen)=\"{ value }\">\n\t\t\t\t    {{ convertDateTime(value) }}\n\t\t\t\t</template>\n\t\t\t\t<template #cell(is_in_black_list)=\"{ value }\">\n\t\t\t\t    {{ getAllocate(value) }}\n\t\t\t\t</template>\n\n                <template #cell(actions)=\"{ row }\">\n                    <va-button-group>\n                        <va-button small icon=\"edit\" color=\"primary\" @click=\"editMachine(row)\" />\n                        <!-- <va-button small icon=\"delete\" color=\"danger\" @click=\"deleteMachine(row)\" /> -->\n                    </va-button-group>\n                </template>\n            </VaDataTable>\n\t\t\t\n\t\t\t<VaModal\n\t\t\t  v-model=\"isEditModalVisible\"\n\t\t\t  title=\"编辑机器信息\"\n\t\t\t  @cancel=\"onCancel\"\n\t\t\t  @ok=\"onOk\"\n\t\t\t>\n\t\t\t  <VaForm>\n\t\t\t    <VaInput\n\t\t\t      v-model=\"editForm.hostname\"\n\t\t\t      label=\"机器名\"\n\t\t\t      placeholder=\"请输入机器名\"\n\t\t\t\t  class=\"mb-2\"\n\t\t\t    />\n\t\t\t\t<VaSelect\n\t\t\t\t        v-model=\"editForm.sub_user_name\"\n\t\t\t\t        label=\"子账户名\"\n\t\t\t\t        :options=\"subUserOptions\"\n\t\t\t\t        placeholder=\"请选择账户\"\n\t\t\t\t\t\tselected-top-shown\n\t\t\t\t        class=\"mb-2\"\n\t\t\t\t/>\n\t\t\t\t<va-select\n\t\t\t\t        v-model=\"editForm.currency\"\n\t\t\t\t        label=\"币种\"\n\t\t\t\t        :options=\"currencyOptions\"\n\t\t\t\t        placeholder=\"请选择币种\"\n\t\t\t\t\t\tselected-top-shown\n\t\t\t\t        class=\"mb-2\"\n\t\t\t\t/>\n\t\t\t\t<VaInput\n\t\t\t\t  v-model=\"editForm.group\"\n\t\t\t\t  label=\"分组\"\n\t\t\t\t  placeholder=\"请输入分组\"\n\t\t\t\t  class=\"mb-2\"\n\t\t\t\t/>\n\t\t\t\t<VaInput\n\t\t\t\t  v-model=\"editForm.idc\"\n\t\t\t\t  label=\"机房\"\n\t\t\t\t  placeholder=\"请输入机房\"\n\t\t\t\t  class=\"mb-2\"\n\t\t\t\t/>\n\t\t\t    <va-select\n\t\t\t\t\t v-model=\"editForm.is_in_black_list\"\n\t\t\t\t\t label=\"是否参与分配\"\n\t\t\t\t\t :options=\"allocateOptions\"\n\t\t\t\t\t placeholder=\"请选择\"\n\t\t\t\t\t class=\"mb-2\"\n\t\t\t    />\t\t  \n\t\t\t  </VaForm>\n\t\t\t</VaModal>\n\t\t\t\n            <!-- 移动端显示卡片列表 -->\n            <!-- <div class=\"mobile-list hidden-md-and-up\">\n                <va-card v-for=\"machine in filteredMachines\" :key=\"machine.id\" class=\"mb-3\">\n                    <div class=\"mobile-list-item\">\n                        <div class=\"mb-2\">\n                            <strong>ID:</strong> {{ machine.id }}\n                        </div>\n                        <div class=\"mb-2\">\n                            <strong>名称:</strong> {{ machine.name }}\n                        </div>\n                        <div class=\"mb-2\">\n                            <strong>状态:</strong>\n                            <va-badge :color=\"getStatusColor(machine.status)\">\n                                {{ machine.status }}\n                            </va-badge>\n                        </div>\n                        <div class=\"mobile-actions\">\n                            <va-button-group>\n                                <va-button small icon=\"edit\" color=\"primary\" @click=\"editMachine(machine)\" />\n                                <va-button small icon=\"delete\" color=\"danger\" @click=\"deleteMachine(machine)\" />\n                            </va-button-group>\n                        </div>\n                    </div>\n                </va-card>\n            </div> -->\n        </div>\n\n        <!-- 分页 -->\n        <!-- <va-pagination v-model=\"currentPage\" :total=\"totalItems\" :per-page=\"perPage\" class=\"mt-4\" /> -->\n        <div class=\"flex justify-end mt-4\">\n          <VaPagination\n            v-model=\"currentStartIndex\"\n            :page-size=\"queryParams.pagesize\"\n            visible-pages=\"5\"\n            :total=\"totalItems\"\n            buttons-preset=\"secondary\"\n            boundary-numbers\n            @update:modelValue=\"handlePageChange\"\n          />\n          <span class=\"ml-4 self-center text-gray-600\">\n            共 {{ totalItems }} 条记录\n          </span>\n        </div>\n    </va-card>\n</template>\n\n<script setup>\nimport { ref, reactive } from 'vue'\nimport { machinList, updateMachine,machineOptions } from \"../../api/machines\"\nimport { formatDateTime,convertDateTime } from \"../../utils/date.ts\";\nimport { useToast } from \"vuestic-ui\";\n\nconst { init: toast } = useToast()\n\n// 响应式状态\nconst searchMachine = ref('');\nconst searchMobile = ref('');\nconst searchSubUser = ref('');\nconst searchCurrency = ref('');\nconst searchUid = ref('');\nconst searchIdc = ref('');\nconst currencyOptions = ref([])\nconst idcOptions = ref([])\nconst subUserOptions = ref([])\nconst isEditModalVisible = ref(false);\nconst editForm = reactive({\n  id: null,\n  hostname: \"\",\n  sub_user_name: \"\",\n  currency: \"\",\n  group: \"\",\n  is_in_black_list: \"\",\n});\n\nconst currentStartIndex = ref(1);\nconst totalItems = ref(100)\nconst machines = ref([])\nconst loading = ref(false)\n// 查询参数\nconst queryParams = reactive({\n  page: 1,\n  pagesize: 10,\n})\n\nconst allocateOptions = [\n    { value: '0', text: '是' },\n\t{ value: '1', text: '否' },\n]\n\nconst convertToOptions = (arr) => \n  arr.map(item => ({ value: item, text: item }))\n  \nconst fetchMachineOptions = async () => {\n  try {\n    const response = await machineOptions()\n      // 带空值保护的转换\n      currencyOptions.value = convertToOptions(response.currencies || [])\n      idcOptions.value = convertToOptions(response.idcs || [])\n      subUserOptions.value = convertToOptions(response.sub_users || [])\n    \n  } catch (error) {\n    console.error('接口调用失败:', error)\n    // 异常处理逻辑\n  }\n}\n\nconst columns = [\n\n    { key: 'id', label: '机器ID' },\n    { key: 'hostname', label: '机器名' },\n    { key: 'idc', label: '机房' },\n    { key: 'currency', label: '币种' },\n    { key: 'model_name', label: '机器类型' },\n\t{ key:'uid', label: '用户UID' },\n    { key:'sub_user_name', label: '子账户名' },\n    { key: 'mobile', label: '手机号' },\n    {key: 'last_seen', label: '最近提交时间' },\n    {key: 'created_time', label: '创建时间' },\n\t{key: 'is_in_black_list', label: '是否参与分配'},\n    { key: 'actions', label: '操作' }\n]\n\n// 分页\nconst handlePageChange = (startIndex) => {\n    queryParams.page = Math.ceil(startIndex / queryParams.pagesize);\n    currentStartIndex.value = startIndex;\n    fetchData();\n};\n\n// 方法\nconst fetchData = async () => {\n    loading.value = true\n    try {\n\t\tconst params = {\n\t\t      ...queryParams,\n\t\t      mobile: searchMobile.value,\n\t\t      hostname: searchMachine.value,\n\t\t\t  sub_user_name: searchSubUser.value,\n\t\t\t  currency: searchCurrency.value.value,\n\t\t\t  uid: searchUid.value,\n\t\t\t  idc: searchIdc.value.value\n\t\t    };\n        const res = await machinList(params)\n\n        if (res && Array.isArray(res.machines) && typeof res.total === \"number\") {\n              machines.value = res.machines;\n              totalItems.value = res.total;\n\t\t} else if (res.machines === null) {\n\t\t\tmachines.value = [];\n\t\t\ttotalItems.value = 0;\n\t\t} else {\n            toast({\n                message: \"查询错误\",\n                color: \"danger\",\n            })\n        }\n    } catch (error) {\n        console.error(\"获取数据失败:\", error)\n        toast({\n            message: \"获取数据失败\",\n            color: \"danger\",\n        })\n    } finally {\n        loading.value = false\n    }\n}\n\nconst getStatusColor = (status) => {\n    const colors = {\n        active: 'success',\n        inactive: 'warning',\n        error: 'danger'\n    }\n    return colors[status] || 'gray'\n}\n\nconst refreshList = () => {\n    fetchData()\n}\n\nconst editMachine = (machine) => {\n  // 绑定当前行的数据到编辑表单\n  editForm.id = machine.rowData.id;\n  editForm.hostname = machine.rowData.hostname;\n  editForm.sub_user_name = machine.rowData.sub_user_name+\" (\"+machine.rowData.uid+\")\";\n  editForm.currency = machine.rowData.currency;\n  editForm.group = machine.rowData.group;\n  editForm.idc = machine.rowData.idc;\n  editForm.is_in_black_list = getAllocate(machine.rowData.is_in_black_list);\n  // 显示弹窗\n  isEditModalVisible.value = true;\n};\n\nconst getAllocate = (isNotAllocate) => {\n\tif ((isNotAllocate === 0) || (isNotAllocate === '0')) {\n\t\treturn '是'\n\t}\n\treturn '否'\n}\n\nconst onCancel = () => {\n  isEditModalVisible.value = false;\n  resetForm();\n};\n\nconst refreshData = () => {\n\tfetchData();\n\tfetchMachineOptions();\n}\n\nconst onOk = async () => {\n  try {\n    // 提交修改\n\tlet sub_user_name = editForm.sub_user_name.value\n\tif (sub_user_name != undefined) {\n\t\tsub_user_name = sub_user_name.substring(0,sub_user_name.indexOf(\" \"))\n\t}\n\t// console.log(\"res is\",editForm.sub_user_name.value)\n\t// console.log(\"value is\",editForm.sub_user_name.value.substring(0,7))\n\t// console.log(\"num is\",editForm.sub_user_name.value.indexOf(\" \"))\n    const msg = await updateMachine(editForm.id, {\n      hostname: editForm.hostname,\n\t  sub_user_name: sub_user_name,\n\t  idc: editForm.idc,\n\t  currency:editForm.currency.value,\n\t  is_in_black_list:editForm.is_in_black_list.value,\n\t  group:editForm.group\n    });\n    toast({\n      message: msg,\n      color: \"success\",\n    });\n    // 刷新数据\n    await fetchData();\n    // 关闭弹窗\n    isEditModalVisible.value = false;\n  } catch (error) {\n    console.error(\"更新失败:\", error);\n    toast({\n      message: \"更新失败\",\n      color: \"danger\",\n    });\n  }\n};\n\nconst resetForm = () => {\n  editForm.id = null;\n  editForm.hostname = \"\";\n  editForm.sub_user_name = \"\";\n};\n\nconst deleteMachine = async (machine) => {\n    // 实现删除逻辑\n}\n\n// 初始化加载数据\nfetchData()\nfetchMachineOptions()\n</script>\n\n<style scoped>\n.machines-list {\n    padding: 20px;\n}\n\n.filters-row {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 10px;\n    align-items: center;\n}\n\n.filter-item {\n    min-width: 150px;\n}\n\n.mobile-list-item {\n    padding: 10px;\n}\n\n.mobile-actions {\n    display: flex;\n    justify-content: flex-end;\n    margin-top: 10px;\n}\n\n.action-buttons {\n    display: flex;\n    gap: 0.5rem;\n    justify-content: center;\n    padding-left: 5px;\n    padding-right: 5px;\n    min-width: 40px; /* 确保按钮有足够空间 */\n  }\n\n@media (max-width: 768px) {\n    .machines-list {\n        padding: 10px;\n    }\n\n    .filter-item {\n        width: 100%;\n        min-width: unset;\n    }\n}\n\n.custom-modal .va-modal-footer {\n  display: none; /* 隐藏默认的 footer */\n}\n</style>"],"names":["toast","useToast","searchMachine","ref","searchMobile","searchSubUser","searchCurrency","searchUid","searchIdc","currencyOptions","idcOptions","subUserOptions","isEditModalVisible","editForm","reactive","currentStartIndex","totalItems","machines","loading","queryParams","allocateOptions","convertToOptions","arr","item","fetchMachineOptions","response","machineOptions","error","columns","handlePageChange","startIndex","fetchData","params","res","machinList","refreshList","editMachine","machine","getAllocate","isNotAllocate","onCancel","resetForm","refreshData","onOk","sub_user_name","msg","updateMachine"],"mappings":"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"}