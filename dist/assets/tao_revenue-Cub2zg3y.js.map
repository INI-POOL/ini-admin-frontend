{"version":3,"file":"tao_revenue-Cub2zg3y.js","sources":["../../src/pages/pre_alloc/tao_revenue.vue"],"sourcesContent":["<template>\n    <va-card class=\"machines-list\">\n        <!-- 搜索和过滤区域 -->\n        <div class=\"mb-4\">\n            <div class=\"filters-row\">\n\t\t\t\t<va-input v-model=\"searchHotkey\" placeholder=\"搜索地址名\" class=\"mr-5\" :style=\"{ maxWidth: '13%'}\">\n\t\t\t\t    <template #prepend>\n\t\t\t\t        <!-- <va-icon name=\"va-calendar\" /> -->\n\t\t\t\t    </template>\n\t\t\t\t</va-input>\n                <va-date-input\n                    v-model=\"searchDate\"\n                    placeholder=\"选择日期\"\n                    class=\"mr-5\"\n                    :style=\"{ maxWidth: '12%'}\"\n\t\t\t\t\t:allowed-days=\"(date) => !isDateDisabled(date)\"\n                />\n\t\t\t\t<va-select v-model=\"searchGroup\" :options=\"groupOptions\" placeholder=\"组名\" class=\"filter-item mr-6\" :style=\"{ maxWidth: '12%' }\" />\n                <va-button @click=\"refreshData\" class=\"\" color=\"rgb(47, 148, 172)\">\n                    重置\n                </va-button>\n            </div>\n        </div>\n\t\t<div class=\"mb-4\">\n\t\t\t<h4 class=\"va-h6\">\n\t\t\t\t总收益: {{totalProfit}} TAO (最近更新时间:{{latestDate}})\n\t\t\t</h4>\n\t\t</div>\n\n        <!-- 列表区域 -->\n        <div class=\"table-responsive\">\n            \n            <VaDataTable :items=\"poolProfits\" :columns=\"columns\" striped class=\"responsive-table\">\n                <template #cell(record_date)=\"{ value }\">\n                    {{ value ? value.split('T')[0] : '' }}\n                </template>\n\t\t\t\t<template #cell(need_allocate)=\"{ value }\">\n\t\t\t\t    {{ getIsAllocate(value)}}\n\t\t\t\t</template>\n\t\t\t\t<template #cell(hotkey)=\"{ value }\">\n\t\t\t\t   <template v-if=\"!value\">无</template>\n\t\t\t\t\n\t\t\t\t   <a v-else :title=\"value\" target=\"_blank\">  <!-- 悬浮显示完整内容 -->\n\t\t\t\t\t {{ truncateText(value, 20) }}\n\t\t\t\t   </a>\n\t\t\t\t</template>\n\t\t\t\t<template #cell(coldkey)=\"{ value }\">\n\t\t\t\t   <template v-if=\"!value\">无</template>\n\t\t\t\t\n\t\t\t\t   <a v-else :title=\"value\" target=\"_blank\">  <!-- 悬浮显示完整内容 -->\n\t\t\t\t\t {{ truncateText(value, 20) }}\n\t\t\t\t   </a>\n\t\t\t\t</template>\n                <template #cell(actions)=\"{ row }\">\n                    <va-button-group>\n                        <va-button icon=\"edit\" size=\"small\" color=\"rgb(47, 148, 172)\" @click=\"editProfit(row)\" />\n                    </va-button-group>\n                </template>\n            </VaDataTable>\n            \n            <!-- 添加编辑弹窗 -->\n            <VaModal\n                v-model=\"isEditModalVisible\"\n                title=\"修改记录\"\n                @cancel=\"onCancel\"\n                @ok=\"onOk\"\n            >\n                <VaForm>\n                    <va-select\n                        v-model=\"editForm.need_allocate\"\n                        label=\"是否需要分配\"\n                        :options=\"allocateOptions\"\n                        placeholder=\"请选择\"\n                        class=\"mb-2\"\n                    />\n                </VaForm>\n            </VaModal>\n        </div>\n\n        <!-- 分页 -->\n        <div class=\"flex justify-end mt-4\">\n            <VaPagination\n                v-model=\"currentStartIndex\"\n                :page-size=\"queryParams.pagesize\"\n                visible-pages=\"5\"\n                :total=\"totalItems\"\n                buttons-preset=\"secondary\"\n                boundary-numbers\n                @update:modelValue=\"handlePageChange\"\n            />\n            <span class=\"ml-4 self-center text-gray-600\">\n                共 {{ totalItems }} 条记录\n            </span>\n        </div>\n    </va-card>\n</template>\n\n<script setup>\nimport { ref, reactive } from 'vue'\nimport { getPoolProfits, updatePoolProfit } from \"../../api/node\"\nimport { taoProfitOptions } from \"../../api/machines\"\nimport { formatDateTime,isDateDisabled,formatReleaseTime } from \"../../utils/date.ts\"\nimport { useToast } from \"vuestic-ui\"\n\nconst { init: toast } = useToast()\n\n// 响应式状态\n// 获取默认日期（当前日期减一天）\n\n\n// 修改初始值\nconst searchDate = ref()\nconst searchHotkey = ref()\nconst searchCurrency = ref('')\n\nconst groupOptions = ref([]);\nconst searchGroup = ref(groupOptions[0]);\nconst totalProfit = ref(0)\nconst latestDate = ref('')\n\nconst convertToOptions = (arr) => \n  arr.map(item => ({ value: item, text: item }));\nconst fetchMachineOptions = async () => {\n  try {\n    const response = await taoProfitOptions()\n      // 带空值保护的转换\n\t  const defaultOption = { value: '', text: '所有' };\n\t  groupOptions.value = [defaultOption, ...convertToOptions(response || [])];\n  } catch (error) {\n    console.error('接口调用失败:', error)\n    // 异常处理逻辑\n  }\n}\n\nconst truncateText = (text, maxLength) => {\n  if (!text) return '';\n  if (text.length <= maxLength) return text;\n  const ellipsis = '...';\n  if (maxLength <= ellipsis.length) {\n    return ellipsis.slice(0, maxLength);\n  }\n  const availableLength = maxLength - ellipsis.length;\n  const frontLength = Math.floor(availableLength / 2);\n  const backLength = availableLength - frontLength;\n  return text.slice(0, frontLength) + ellipsis + text.slice(-backLength);\n};\n\nconst currentStartIndex = ref(1)\nconst totalItems = ref(0)\nconst poolProfits = ref([])\nconst loading = ref(false)\n\n// 修改查询参数的初始化\nconst queryParams = reactive({\n    page: 1,\n    pagesize: 15,\n    date: new Date().toISOString().split('T')[0],\n    currency: ''\n})\n\n// 添加日期格式化函数\nconst formatDate = (date) => {\n    if (!date) return ''\n    const d = new Date(date)\n    const year = d.getFullYear()\n    const month = String(d.getMonth() + 1).padStart(2, '0')\n    const day = String(d.getDate()).padStart(2, '0')\n    return `${year}-${month}-${day}`\n}\n\n// 修改 fetchData 方法\nconst fetchData = async () => {\n    loading.value = true\n    try {\n        const params = {\n            page: queryParams.page,\n            pagesize: queryParams.pagesize,\n            currency: 'tao',\n\t\t\tgroup: searchGroup.value?.value,\n\t\t\thotkey: searchHotkey.value\n        }\n        \n        // 只有当选择了日期时才添加日期参数\n        if (searchDate.value) {\n            params.date = formatDate(searchDate.value)\n        }\n        \n        const res = await getPoolProfits(params)\n        // 因为拦截器已经处理了 res.data 的解构，这里直接使用返回值\n        if (res?.pool_profits) {\n            poolProfits.value = res.pool_profits\n            totalItems.value = res.total\n\t\t\ttotalProfit.value = res.total_profit\n\t\t\tlatestDate.value = formatReleaseTime(res.pool_profits[0].timestamp)\n        } else {\n            poolProfits.value = []\n            totalItems.value = 0\n        }\n    } catch (error) {\n        console.error(\"获取数据失败:\", error)\n        toast({\n            message: error.message || \"获取数据失败\",\n            color: \"danger\",\n        })\n        poolProfits.value = []\n        totalItems.value = 0\n    } finally {\n        loading.value = false\n    }\n}\n\n// 添加 watch 以监听搜索条件变化\nimport { watch } from 'vue'\n\nwatch([searchDate, searchCurrency,searchGroup,searchHotkey], () => {\n    queryParams.page = 1\n    currentStartIndex.value = 1\n    fetchData()\n\tfetchMachineOptions()\n})\n\n\nconst columns = [\n    { key: 'id', label: 'ID',width:'100px' },\n    { key: 'record_date', label: '记录日期',width:'160px' },\n\t{ key: 'group', label: '分组',width:'160px' },\n\t{ key: 'profit', label: '收益'},\n    { key: 'hotkey', label: 'Hotkey',width:'240px' },\n\t{ key: 'coldkey', label: 'Coldkey',width:'240px' },\n    // { key: 'network', label: '网络' },\n    { key: 'subnet', label: '子网' },\n    { key: 'need_allocate', label: '是否需要分配' },\n    { key: 'actions', label: '操作' }  // 添加操作列\n]\n\n// 添加编辑相关的响应式变量和方法\nconst isEditModalVisible = ref(false)\nconst editForm = reactive({\n    id: null,\n    real_power: '',\n    real_reward: '',\n    need_allocate: '',\n})\n\nconst allocateOptions = [\n    { value: '1', text: '是' },\n    { value: '0', text: '否' },\n]\n\nconst getIsAllocate = (need_allocate) => {\n\tif (need_allocate === 1 || need_allocate === \"1\") {\n\t\treturn '是'\n\t}\n\treturn '否'\n}\n\nconst editProfit = (row) => {\n    editForm.id = row.rowData.id\n    editForm.real_power = row.rowData.real_power\n    editForm.real_reward = row.rowData.real_reward\n    editForm.need_allocate = row.rowData.need_allocate === 1 ? \"是\" : \"否\" \n    isEditModalVisible.value = true\n}\n\nconst onOk = async () => {\n    try {\n        const msg = await updatePoolProfit(editForm.id, {\n            real_power: Number(editForm.real_power),\n            real_reward: Number(editForm.real_reward),\n            need_allocate: Number(editForm.need_allocate?.value)\n        })\n        toast({\n            message: msg,\n            color: \"success\",\n        })\n        await fetchData()\n\t\tawait fetchMachineOptions()\n        isEditModalVisible.value = false\n    } catch (error) {\n        console.error(\"修改失败:\", error)\n        toast({\n            message: error.message || \"修改失败\",\n            color: \"danger\",\n        })\n    }\n}\n\nconst onCancel = () => {\n    isEditModalVisible.value = false\n    resetForm()\n}\n\nconst resetForm = () => {\n    editForm.id = null\n    editForm.real_power = ''\n    editForm.real_reward = ''\n    editForm.need_allocate = ''\n}\n\n// 分页\nconst handlePageChange = (startIndex) => {\n    queryParams.page = Math.ceil(startIndex / queryParams.pagesize)\n    currentStartIndex.value = startIndex\n    fetchData()\n\tfetchMachineOptions()\n}\n\nconst refreshData = () => {\n\tsearchDate.value = null;\n\tsearchGroup.value = '';\n\tsearchCurrency.value = '';\n\tsearchHotkey.value = ''\n    fetchData()\n\tfetchMachineOptions()\n}\n\n// 初始化加载数据\nfetchData()\nfetchMachineOptions()\n</script>\n\n<style scoped>\n.machines-list {\n    padding: 20px;\n}\n\n.filters-row {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 10px;\n    align-items: center;\n    margin-top: 0; /* 移除之前的 mt-4 */\n}\n\n.filter-item {\n    min-width: 150px;\n}\n\n.mobile-list-item {\n    padding: 10px;\n}\n\n.mobile-actions {\n    display: flex;\n    justify-content: flex-end;\n    margin-top: 10px;\n}\n\n.action-buttons {\n    display: flex;\n    gap: 0.5rem;\n    justify-content: center;\n    padding-left: 5px;\n    padding-right: 5px;\n    min-width: 40px; /* 确保按钮有足够空间 */\n  }\n\n@media (max-width: 768px) {\n    .machines-list {\n        padding: 10px;\n    }\n\n    .filter-item {\n        width: 100%;\n        min-width: unset;\n    }\n}\n\n.custom-modal .va-modal-footer {\n  display: none; /* 隐藏默认的 footer */\n}\n</style>"],"names":["toast","useToast","searchDate","ref","searchHotkey","searchCurrency","groupOptions","searchGroup","totalProfit","latestDate","convertToOptions","arr","item","fetchMachineOptions","response","taoProfitOptions","defaultOption","error","truncateText","text","maxLength","ellipsis","availableLength","frontLength","backLength","currentStartIndex","totalItems","poolProfits","loading","queryParams","reactive","formatDate","date","d","year","month","day","fetchData","params","_a","res","getPoolProfits","formatReleaseTime","watch","columns","isEditModalVisible","editForm","allocateOptions","getIsAllocate","need_allocate","editProfit","row","onOk","msg","updatePoolProfit","onCancel","resetForm","handlePageChange","startIndex","refreshData"],"mappings":"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"}