{"version":3,"file":"pre_machine-BuGG1sBN.js","sources":["../../src/pages/pre_alloc/pre_machine.vue"],"sourcesContent":["<template>\n    <va-card class=\"machines-list\">\n        <!-- 搜索和过滤区域 -->\n        <div class=\"mb-4\">\n\t\t\t机器名：\n\t\t\t<va-input v-model=\"searchMachine\" placeholder=\"搜索机器名\" class=\"mb-1 mr-8\" :style=\"{ maxWidth: '15%'}\">\n\t\t\t    <template #prepend>\n\t\t\t        <!-- <va-icon name=\"va-calendar\" /> -->\n\t\t\t    </template>\n\t\t\t</va-input>\n\t\t\t记录日期：\n\t\t\t<va-date-input\n\t\t\t      v-model=\"searchDate\"\n\t\t\t      placeholder=\"选择日期\"\n\t\t\t      class=\"mb-1 mr-5\"\n\t\t\t      :style=\"{ maxWidth: '16%'}\"\n\t\t\t\t  :allowed-days=\"(date) => !isDateDisabled(date)\"\n\t\t\t/>\n\t\t\t分组：\n\t\t\t<va-select v-model=\"searchGroup\" :options=\"groupOptions\" placeholder=\"组名\" class=\"filter-item mb-1 mr-8\" :style=\"{ maxWidth: '13%' }\" />\n\t\t\t参与分配：\n\t\t\t<va-select v-model=\"searchAlloc\" :options=\"allocateOptions\" placeholder=\"是否参与分配\" class=\"filter-item mb-1 mr-8\" :style=\"{ maxWidth: '10%' }\" />\n\t\t\t<va-button @click=\"refreshData\" class=\"mb-1 mr-8\" color=\"rgb(47, 148, 172)\">\n\t\t\t刷新\n\t\t\t</va-button>\n        </div>\n\n        <!-- 列表区域 -->\n        <div class=\"table-responsive\">\n            <!-- 桌面端显示表格 -->\n            <VaDataTable :items=\"machines\" :columns=\"columns\" striped  class=\"responsive-table\">\n                <!-- 时间显示 -->\n                <template #cell(created_time)=\"{ value }\">\n                    {{ formatDateTime(value) }}\n                </template>\n\t\t\t\t<template #cell(hashrate)=\"{ value }\">\n\t\t\t\t    {{ formatHashRate(value) }}\n\t\t\t\t</template>\n\t\t\t\t<template #cell(record_date)=\"{ value }\">\n\t\t\t\t    {{ convertDateTimeToDate(value) }}\n\t\t\t\t</template>\n\t\t\t\t<template #cell(is_in_black_list)=\"{ value }\">\n\t\t\t\t    {{ getAllocate(value) }}\n\t\t\t\t</template>\n\n                <template #cell(actions)=\"{ row }\">\n                    <va-button-group>\n                        <va-button size=\"small\" color=\"rgb(47, 148, 172)\" icon=\"edit\" @click=\"editMachine(row)\" />\n                        <!-- <va-button small icon=\"delete\" color=\"danger\" @click=\"deleteMachine(row)\" /> -->\n                    </va-button-group>\n                </template>\n            </VaDataTable>\n\t\t\t\n\t\t\t<VaModal\n\t\t\t  v-model=\"isEditModalVisible\"\n\t\t\t  title=\"修改机器信息\"\n\t\t\t  @cancel=\"onCancel\"\n\t\t\t  @ok=\"onOk\"\n\t\t\t>\n\t\t\t  <VaForm>\n\t\t\t    <VaInput\n\t\t\t      v-model=\"editForm.hostname\"\n\t\t\t      label=\"机器名\"\n\t\t\t\t  class=\"mb-2\"\n\t\t\t\t  readonly\n\t\t\t    />\n\t\t\t\t<VaInput\n\t\t\t\t  v-model=\"editForm.record_date\"\n\t\t\t\t  label=\"记录日期\"\n\t\t\t\t  class=\"mb-2\"\n\t\t\t\t  readonly\n\t\t\t\t/>\n\t\t\t\t<va-input\n\t\t\t\t        v-model=\"editForm.online_points\"\n\t\t\t\t        label=\"在线时长点数\"\n\t\t\t\t\t\ttype=\"number\"\n\t\t\t\t\t\tplaceholder=\"请输入0~288的整数\"\n\t\t\t\t\t\t:min=\"0\"\n\t\t\t\t\t\t:max=\"288\"\n\t\t\t\t\t\tselected-top-shown\n\t\t\t\t        class=\"mb-2\"\n\t\t\t\t\t\t@input=\"validateOnlinePoints\"\n\t\t\t\t>\n\t\t\t\t  <template #messages>\n\t\t\t\t\t<div v-if=\"errorMessage\" class=\"va-text-danger\">{{ errorMessage }}</div>\n\t\t\t\t  </template>\n\t\t\t\t</va-input>\n\t\t\t\t<VaInput\n\t\t\t\t  v-model=\"editForm.hashrate\"\n\t\t\t\t  label=\"算力\"\n\t\t\t\t  type=\"number\"\n\t\t\t\t  placeholder=\"请输入算力\"\n\t\t\t\t  class=\"mb-2\"\n\t\t\t\t/>\t  \n\t\t\t  </VaForm>\n\t\t\t</VaModal>\n\t\t\t\n            <!-- 移动端显示卡片列表 -->\n            <!-- <div class=\"mobile-list hidden-md-and-up\">\n                <va-card v-for=\"machine in filteredMachines\" :key=\"machine.id\" class=\"mb-3\">\n                    <div class=\"mobile-list-item\">\n                        <div class=\"mb-2\">\n                            <strong>ID:</strong> {{ machine.id }}\n                        </div>\n                        <div class=\"mb-2\">\n                            <strong>名称:</strong> {{ machine.name }}\n                        </div>\n                        <div class=\"mb-2\">\n                            <strong>状态:</strong>\n                            <va-badge :color=\"getStatusColor(machine.status)\">\n                                {{ machine.status }}\n                            </va-badge>\n                        </div>\n                        <div class=\"mobile-actions\">\n                            <va-button-group>\n                                <va-button small icon=\"edit\" color=\"primary\" @click=\"editMachine(machine)\" />\n                                <va-button small icon=\"delete\" color=\"danger\" @click=\"deleteMachine(machine)\" />\n                            </va-button-group>\n                        </div>\n                    </div>\n                </va-card>\n            </div> -->\n        </div>\n\n        <!-- 分页 -->\n        <!-- <va-pagination v-model=\"currentPage\" :total=\"totalItems\" :per-page=\"perPage\" class=\"mt-4\" /> -->\n        <div class=\"flex justify-end mt-4\">\n          <VaPagination\n            v-model=\"currentStartIndex\"\n            :page-size=\"queryParams.pagesize\"\n            visible-pages=\"5\"\n            :total=\"totalItems\"\n            buttons-preset=\"secondary\"\n            boundary-numbers\n            @update:modelValue=\"handlePageChange\"\n          />\n          <span class=\"ml-4 self-center text-gray-600\">\n            共 {{ totalItems }} 条记录\n          </span>\n        </div>\n    </va-card>\n</template>\n\n<script setup>\nimport { ref, reactive, computed } from 'vue'\nimport { preMachineList, preMachineModify, machineOptions } from \"../../api/machines\"\nimport { formatDateTime,convertDateTimeToDate,isDateDisabled,getYesterday,formatHashRate } from \"../../utils/date.ts\";\nimport { useToast,VaDatePicker, VaButton, VaIcon,VaPopover } from \"vuestic-ui\";\nimport { useI18n } from \"vue-i18n\";\nconst { t } = useI18n();\n\nconst { init: toast } = useToast()\n\nconst allocateOptions = [\n    { value: '0', text: '是' },\n\t{ value: '1', text: '否' },\n];\nconst groupOptions = ref([]);\n\nconst searchDate = ref(getYesterday(8)) // 存储 Date 对象\nconst searchMachine = ref('');\nconst searchAlloc = ref(allocateOptions[0]);\nconst searchGroup = ref(groupOptions[0]);\n\nconst isEditModalVisible = ref(false);\n\nconst editForm = reactive({\n  id: null,\n  online_points: 0.0,\n  hashrate: 0.0,\n  record_date: ''\n});\n\nconst errorMessage = ref('');\nconst validateOnlinePoints = (value) => {\n  const num = Number(value.data);\n  console.log(\"num is\",num)\n  if (isNaN(num)) {\n    errorMessage.value = '必须输入数字';\n  } else if (!Number.isInteger(num)) {\n    errorMessage.value = '必须为整数';\n  } else if (num < 0 || num > 288) {\n    errorMessage.value = '范围0~288';\n  } else {\n    errorMessage.value = '';\n  }\n};\n\nconst convertToOptions = (arr) => \n  arr.map(item => ({ value: item, text: item }));\nconst fetchMachineOptions = async () => {\n  try {\n    const response = await machineOptions()\n      // 带空值保护的转换\n\t  const defaultOption = { value: '', text: '所有' };\n\t  groupOptions.value = [defaultOption, ...convertToOptions(response.groups || [])];\n  } catch (error) {\n    console.error('接口调用失败:', error)\n    // 异常处理逻辑\n  }\n}\n\nconst currentStartIndex = ref(1);\nconst totalItems = ref(100)\nconst machines = ref([])\nconst loading = ref(false)\nconst queryParams = reactive({\n  page: 1,\n  pagesize: 10,\n})\n\nconst columns = [\n\t// { key: 'id',label: 'ID'},\n    { key: 'mid', label: t('admin.mid') },\n    { key: 'hostname', label: t('admin.mName') },\n    { key: 'record_date', label: t('admin.recordDate') },\n    { key: 'currency', label: t('admin.currency') },\n\t{ key:'uid', label: t('admin.userUid') },\n    { key:'sub_user_name', label: t('admin.subUserName') },\n    {key: 'online_time', label: t('admin.onlineTimes') },\n    {key: 'online_points', label: t('admin.onlinePoints') },\n\t{ key: 'hashrate', label: t('admin.avgHashrate') },\n\t{key: 'is_in_black_list', label: t('admin.needAllocate')},\n\t{key: 'group', label: t('admin.groupName')},\n    { key: 'actions', label: t('admin.operation') }\n]\n\n// 分页\nconst handlePageChange = (startIndex) => {\n    queryParams.page = Math.ceil(startIndex / queryParams.pagesize);\n    currentStartIndex.value = startIndex;\n    fetchData();\n};\n\nconst formatDate = (date) => {\n    if (!date) return ''\n    const d = new Date(date)\n    const year = d.getFullYear()\n    const month = String(d.getMonth() + 1).padStart(2, '0')\n    const day = String(d.getDate()).padStart(2, '0')\n    return `${year}-${month}-${day}`\n}\n\n// 方法\nconst fetchData = async () => {\n    loading.value = true\n    try {\n\t\n\t\tconst params = {\n\t\t      ...queryParams,\n\t\t\t  is_in_black_list: searchAlloc.value.value,\n\t\t\t  hostname: searchMachine.value,\n\t\t\t  group: searchGroup.value?.value\n\t\t    };\n\t\t\t\n\t\tif (searchDate.value) {\n\t\t\tparams.record_date = formatDate(searchDate.value)\n\t\t}\n\t\t\t\n        const res = await preMachineList(params)\n\n        if (res && Array.isArray(res.machine_info) && typeof res.total === \"number\") {\n              machines.value = res.machine_info;\n              totalItems.value = res.total;\n\t\t} else if (res.machine_info === null) {\n\t\t\tmachines.value = [];\n\t\t\ttotalItems.value = 0;\n\t\t} else {\n            toast({\n                message: \"查询错误\",\n                color: \"danger\",\n            })\n        }\n    } catch (error) {\n        console.error(\"获取数据失败:\", error)\n        toast({\n            message: \"获取数据失败\",\n            color: \"danger\",\n        })\n    } finally {\n        loading.value = false\n    }\n}\n\nconst getStatusColor = (status) => {\n    const colors = {\n        active: 'success',\n        inactive: 'warning',\n        error: 'danger'\n    }\n    return colors[status] || 'gray'\n}\n\nimport { watch } from 'vue'\n\nwatch([searchDate, searchAlloc,searchGroup,searchMachine], () => {\n    queryParams.page = 1\n    currentStartIndex.value = 1\n    fetchData()\n})\n\nconst editMachine = (machine) => {\n  // 绑定当前行的数据到编辑表单\n  editForm.id = machine.rowData.id;\n  editForm.hostname = machine.rowData.hostname;\n  editForm.online_points = machine.rowData.online_points;\n  editForm.hashrate = machine.rowData.hashrate;\n  editForm.record_date = convertDateTimeToDate(machine.rowData.record_date);\n  // 显示弹窗\n  isEditModalVisible.value = true;\n};\n\nconst getAllocate = (isNotAllocate) => {\n\tif ((isNotAllocate === 0) || (isNotAllocate === '0')) {\n\t\treturn '是'\n\t}\n\treturn '否'\n}\n\nconst onCancel = () => {\n  isEditModalVisible.value = false;\n  resetForm();\n};\n\nconst refreshData = () => {\n\tsearchMachine.value = '';\n\tsearchGroup.value = '';\n\t// searchAlloc.value.value = \"0\";\n\t// searchAlloc.value.text = \"是\";\n\t// 分组不刷新\n\tif (searchDate.value) {\n\t\tsearchDate.value = formatDate(getYesterday(8));\n\t}\n\tfetchData();\n\tfetchMachineOptions();\n}\n\nconst onOk = async () => {\n  try {\n\t  console.log(\"record_date is\",editForm.record_date)\n    const msg = await preMachineModify({\n\t  hostname: editForm.hostname,\n\t  record_date: editForm.record_date,\n      online_points: editForm.online_points,\n\t  hashrate: editForm.hashrate,\n    });\n    toast({\n      message: msg,\n      color: \"success\",\n    });\n    // 刷新数据\n    await fetchData();\n    // 关闭弹窗\n    isEditModalVisible.value = false;\n  } catch (error) {\n    console.error(\"更新失败:\", error);\n    toast({\n      message: error,\n      color: \"danger\",\n    });\n  }\n};\n\nconst resetForm = () => {\n  editForm.id = null;\n  editForm.online_points = 0.0;\n  editForm.hashrate = 0.0;\n};\n\nconst deleteMachine = async (machine) => {\n    // 实现删除逻辑\n}\n\n// 初始化加载数据\nfetchData();\nfetchMachineOptions();\n</script>\n\n<style scoped>\n.machines-list {\n    padding: 20px;\n}\n\n.filters-row {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 10px;\n    align-items: center;\n}\n\n.filter-item {\n    min-width: 150px;\n}\n\n.mobile-list-item {\n    padding: 10px;\n}\n\n.mobile-actions {\n    display: flex;\n    justify-content: flex-end;\n    margin-top: 10px;\n}\n\n.action-buttons {\n    display: flex;\n    gap: 0.5rem;\n    justify-content: center;\n    padding-left: 5px;\n    padding-right: 5px;\n    min-width: 40px; /* 确保按钮有足够空间 */\n  }\n\n@media (max-width: 768px) {\n    .machines-list {\n        padding: 10px;\n    }\n\n    .filter-item {\n        width: 100%;\n        min-width: unset;\n    }\n}\n\n.custom-modal .va-modal-footer {\n  display: none; /* 隐藏默认的 footer */\n}\n\n.va-popover__content {\n  z-index: 1000 !important;\n  position: relative !important;\n}\n.va-date-picker {\n  min-width: 300px !important;\n}\n\n</style>"],"names":["t","useI18n","toast","useToast","allocateOptions","groupOptions","ref","searchDate","getYesterday","searchMachine","searchAlloc","searchGroup","isEditModalVisible","editForm","reactive","errorMessage","validateOnlinePoints","value","num","convertToOptions","arr","item","fetchMachineOptions","response","machineOptions","defaultOption","error","currentStartIndex","totalItems","machines","loading","queryParams","columns","handlePageChange","startIndex","fetchData","formatDate","date","d","year","month","day","params","_a","res","preMachineList","watch","editMachine","machine","convertDateTimeToDate","getAllocate","isNotAllocate","onCancel","resetForm","refreshData","onOk","msg","preMachineModify"],"mappings":"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"}