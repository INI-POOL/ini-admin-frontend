import{m as We,p as je,t as Ze,b as Ge}from"./FileSaver.min-PNuPOGa3.js";import{g as re,b as Je,a as Ke}from"./request-Ds9cZTqy.js";import{f as Qe}from"./date-Y2sbzHu6.js";import{u as Xe}from"./useForm-C4At535k.js";import{u as Ye}from"./useToast-CVRP6Xfq.js";import{_ as el,r as a,U as F,e as E,B as ll,g as ol,w as s,f as i,a as H,b as u,i as c,h as t,t as V,u as tl,c as ne,F as al,q as W}from"./index-DEwvr2kN.js";function sl(y){return re("/api/v1/back_stage/notice/list",y)}function nl(y){return Je("/api/v1/back_stage/notice/add",y).then(r=>{if(!r)throw new Error("请求失败，未返回响应数据");return r})}function rl(y){return Ke(`/api/v1/back_stage/notice/delete?id=${y}`).then(r=>{if(!r)throw new Error("请求失败，未返回响应数据");return r})}function ul(){return re("/api/v1/back_stage/notice/type")}const dl={class:"mb-4"},il={class:"filters-row"},ml={class:"table-responsive"},cl=["title","href"],pl={class:"action-container"},vl={class:"dialog-header"},gl={class:"dialog-content"},Vl={class:"version-info"},fl={class:"system-highlight"},_l={class:"version-highlight"},bl={class:"dialog-header"},yl={class:"modal-content"},wl={class:"flex justify-end gap-4"},kl={class:"flex justify-end mt-4"},xl={class:"ml-4 self-center text-gray-600"},Cl={__name:"notice",setup(y){const{init:r}=Ye();Xe("addFormRef");const U=a(!1);a(null),a(null);const j=a(null),f=a(""),D=a(""),h=a(!1),w=a(""),k=a(""),x=a(""),Z=a([]),ue=o=>{j.value=o.id,U.value=!0},de=o=>o.map(e=>({value:e,text:e})),_=async()=>{try{const o=await ul(),e={value:"",text:"所有"};Z.value=[e,...de(o||[])]}catch(o){r({message:o,color:"danger"})}},q=()=>w.value.trim().length,B=()=>k.value.trim().length,$=()=>x.value.trim().length,G=()=>(console.log("titleLength is",q()),console.log("contentLength is",$()),console.log("specLength is",B()),q()>0&&q()<=50&&B()>0&&B()<=100&&$()>0&&$()<=2e3),J=()=>{w.value="",k.value="",x.value=""},ie=async()=>{if(!G()){r({message:"请检查输入内容是否符合要求",color:"danger"});return}const o={title:w.value,title_en:w.value,spec:k.value,spec_en:k.value,content:x.value,content_en:x.value};try{await nl(o),r({message:"新增成功",color:"rgb(47, 148, 172)"})}catch(e){r({message:`删除失败: ${e.message||"未知错误"}`,color:"danger"})}finally{p(),J(),h.value=!1}},me=()=>{J(),h.value=!1},ce=async()=>{try{await rl(j.value),r({message:"删除成功",color:"rgb(47, 148, 172)"})}catch(o){r({message:`删除失败: ${o.message||"未知错误"}`,color:"danger"})}finally{p(),_(),U.value=!1}},pe=()=>{r({message:"已取消删除",color:"info"}),U.value=!1};a({}),a({}),F({});const ve=a([{value:"",text:"所有"},{value:"ios",text:"IOS"},{value:"android",text:"Android"}]),ge=a([{value:"ios",text:"IOS"},{value:"android",text:"Android"}]),z=a(ve[0]);a();const O=a(new Date),I=a(new Date),S=a(!1);a(new Date);const Ve=a({}),fe=o=>!!o||"必须选择时间",_e=o=>{const e=new Date;return new Date(o)<=e?"时间必须晚于当前":!0},K=F({version:"",system:""}),be=E(()=>fe(I.value)===!0&&_e(O.value)===!0);E(()=>["0",0].includes(Ve.value.is_latest));const ye=o=>o==="android"?"Android":"IOS",A=a(1),T=a(0),M=a([]),Q=a(!1),N=a(!1),X=a(null),Y=a(null);a(null),a(null);const we=async()=>{try{await Oe(X.value,Y.value)}catch{}finally{N.value=!1}},ke=async()=>{const o=I.value;o.setHours(O.value.getHours()),o.setMinutes(O.value.getMinutes()),o.setSeconds(0);const e={version:K.version,system:K.system,release_time:o.toLocaleString()};try{await Te(e)}catch{}finally{S.value=!1}},xe=()=>{r({message:"已取消发布",color:"warning"}),N.value=!1},ee=o=>o?/^v\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?$/.test(o)||"格式示例：v1.0.0 或 v2.3.4-beta":"版本号不能为空",le=o=>{if(!o)return"下载链接不能为空";try{return new URL(o),!0}catch{return"请输入有效的URL地址"}};E(()=>(console.log("version is",n.version),console.log("download_url is",n.download_url),ee(n.version)===!0&&le(n.download_url)===!0));const C=F({page:1,pagesize:15}),L=a(!1);a(!1);const n=F({version:"",system:"",download_url:"",release_notes:"",release_notes_en:""}),Ce=()=>{h.value=!0},Ue=(o,e)=>o?o.length>e?o.slice(0,e)+"...":o:"",p=async()=>{var o,e;Q.value=!0;try{const m={page:C.page,pagesize:C.pagesize,content:f==null?void 0:f.value,type:(o=D.value)==null?void 0:o.value};z&&(m.system=(e=z.value)==null?void 0:e.value);const g=await sl(m);g!=null&&g.notices?(M.value=g.notices,T.value=g.total):(M.value=[],T.value=0)}catch(m){console.error("获取数据失败:",m),r({message:m.message||"获取数据失败",color:"danger"}),M.value=[],T.value=0}finally{Q.value=!1}};ll([z,f,D],()=>{C.page=1,A.value=1,p(),_()});const De=[{key:"id",label:"序号"},{key:"title",label:"标题"},{key:"type",label:"通知类型"},{key:"spec",label:"概览"},{key:"content",label:"内容"},{key:"created_time",label:"通知时间"},{key:"actions",label:"操作"}],P=a(!1),d=F({version:"",system:"",release_notes:"",release_notes_en:"",download_url:""}),he=async()=>{try{const o=await We(d.version,d.system,{download_url:d.download_url,release_notes:d.release_notes,release_notes_en:d.release_notes_en});r({message:o,color:"success"}),await p(),P.value=!1}catch(o){console.error("修改失败:",o),r({message:o.message||"修改失败",color:"danger"})}},Oe=async(o,e)=>{try{const m=await je(o,e);r({message:m,color:"success",duration:3e3}),await p(),_()}catch(m){r({message:m.message||"发布失败",color:"danger",duration:5e3})}},Te=async o=>{try{const e=await Ze(o);r({message:e,color:"success",duration:3e4}),await p(),_()}catch(e){r({message:e.message||"定时发布失败",color:"danger",duration:5e3})}},Fe=async()=>{var o;try{const e=await Ge({version:n.version,system:(o=n.system)==null?void 0:o.value,download_url:n.download_url,release_notes:n.release_notes,release_notes_en:n.release_notes_en});r({message:e,color:"success"}),await p(),L.value=!1}catch(e){console.error("修改失败:",e),r({message:e.message||"修改失败",color:"danger"})}},ze=()=>{P.value=!1,Ae()},Ie=()=>{S.value=!1},Se=()=>{L.value=!1,Me()},Ae=()=>{d.version="",d.system="",d.download_url="",d.release_notes="",d.release_notes_en=""},Me=()=>{n.version="",n.system="",n.download_url="",n.release_notes="",n.release_notes_en=""},Ne=o=>{C.page=Math.ceil(o/C.pagesize),A.value=o,p(),_()},Le=()=>{z.value="",f.value="",D.value="",p(),_()};return p(),_(),(o,e)=>{const m=i("va-input"),g=i("va-select"),b=i("va-button"),v=i("VaInput"),oe=i("VaForm"),R=i("VaModal"),te=i("va-button-group"),Pe=i("VaDataTable"),Re=i("VaDateInput"),qe=i("VaTimeInput"),ae=i("va-modal"),se=i("va-icon"),Be=i("va-divider"),$e=i("VaTextarea"),Ee=i("VaPagination"),He=i("va-card");return H(),ol(He,{class:"machines-list"},{default:s(()=>[u("div",dl,[u("div",il,[e[27]||(e[27]=c(" 内容查询： ")),t(m,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=l=>f.value=l),placeholder:"请输入消息内容",class:"mb-1 mr-6",style:{maxWidth:"13%"}},{prepend:s(()=>e[24]||(e[24]=[])),_:1},8,["modelValue"]),e[28]||(e[28]=c(" 类型筛选： ")),t(g,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=l=>D.value=l),options:Z.value,placeholder:"请选择通知类型",class:"mb-1",style:{maxWidth:"16%"}},null,8,["modelValue","options"]),t(b,{onClick:Ce,color:"rgb(47, 148, 172)",class:"mb-1 ml-6"},{default:s(()=>e[25]||(e[25]=[c(" 新增通知 ")])),_:1}),t(b,{onClick:Le,color:"rgb(47, 148, 172)",class:"mb-1 ml-6"},{default:s(()=>e[26]||(e[26]=[c(" 刷新 ")])),_:1}),t(R,{modelValue:L.value,"onUpdate:modelValue":e[7]||(e[7]=l=>L.value=l),title:"新增版本",onCancel:Se,onOk:Fe,"ok-disabled":!0},{default:s(()=>[t(oe,null,{default:s(()=>[t(v,{modelValue:n.version,"onUpdate:modelValue":e[2]||(e[2]=l=>n.version=l),label:"版本号",rules:[ee],required:"",class:"mb-2",placeholder:"v1.0.0"},null,8,["modelValue","rules"]),t(g,{modelValue:n.system,"onUpdate:modelValue":e[3]||(e[3]=l=>n.system=l),label:"操作系统",options:ge.value,placeholder:"IOS",class:"mb-2"},null,8,["modelValue","options"]),t(v,{modelValue:n.download_url,"onUpdate:modelValue":e[4]||(e[4]=l=>n.download_url=l),label:"下载链接",type:"url",rules:[le],required:"",class:"mb-2",placeholder:"https://apps.apple.com/app/..."},null,8,["modelValue","rules"]),t(v,{modelValue:n.release_notes,"onUpdate:modelValue":e[5]||(e[5]=l=>n.release_notes=l),label:"更新日志 (如需换行请用','隔开)",type:"textarea",class:"mb-2"},null,8,["modelValue"]),t(v,{modelValue:n.release_notes_en,"onUpdate:modelValue":e[6]||(e[6]=l=>n.release_notes_en=l),label:"更新日志英文版 (如需换行请用','隔开)",type:"textarea",class:"mb-2"},null,8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])])]),u("div",ml,[t(Pe,{items:M.value,columns:De,striped:"",class:"responsive-table"},{"cell(created_time)":s(({value:l})=>[c(V(tl(Qe)(l)),1)]),"cell(content)":s(({value:l})=>[l?(H(),ne("a",{key:1,title:l,href:l,target:"_blank"},V(Ue(l,10)),9,cl)):(H(),ne(al,{key:0},[c("无")],64))]),"cell(actions)":s(({row:l})=>[u("div",pl,[t(te,null,{default:s(()=>[t(b,{size:"small",icon:"delete",color:"rgb(208, 24, 39)",title:"删除版本",onClick:Ul=>ue(l.rowData),class:"action-icon"},null,8,["onClick"])]),_:2},1024)])]),_:1},8,["items"]),t(R,{modelValue:P.value,"onUpdate:modelValue":e[13]||(e[13]=l=>P.value=l),title:"修改版本信息",onCancel:ze,onOk:he,"ok-props":{color:"rgb(47, 148, 172)",textColor:"white"},"cancel-props":{color:"rgb(47, 148, 172)",textColor:"white"}},{default:s(()=>[t(oe,null,{default:s(()=>[t(v,{modelValue:d.version,"onUpdate:modelValue":e[8]||(e[8]=l=>d.version=l),label:"版本号",type:"string",class:"mb-3",readonly:""},null,8,["modelValue"]),t(v,{modelValue:d.system,"onUpdate:modelValue":e[9]||(e[9]=l=>d.system=l),label:"系统",type:"string",class:"mb-3",readonly:""},null,8,["modelValue"]),t(v,{modelValue:d.download_url,"onUpdate:modelValue":e[10]||(e[10]=l=>d.download_url=l),label:"下载链接",type:"string",class:"mb-3"},null,8,["modelValue"]),t(v,{modelValue:d.release_notes,"onUpdate:modelValue":e[11]||(e[11]=l=>d.release_notes=l),label:"更新日志 (如需换行请用','隔开)",type:"textarea",class:"mb-3"},null,8,["modelValue"]),t(v,{modelValue:d.release_notes_en,"onUpdate:modelValue":e[12]||(e[12]=l=>d.release_notes_en=l),label:"更新日志英文版 (如需换行请用','隔开)",type:"textarea",class:"mb-3"},null,8,["modelValue"])]),_:1})]),_:1},8,["modelValue"]),t(ae,{modelValue:S.value,"onUpdate:modelValue":e[16]||(e[16]=l=>S.value=l),"hide-default-actions":"",title:"选择发布时间"},{default:s(()=>[t(Re,{modelValue:I.value,"onUpdate:modelValue":e[14]||(e[14]=l=>I.value=l)},null,8,["modelValue"]),t(qe,{modelValue:O.value,"onUpdate:modelValue":e[15]||(e[15]=l=>O.value=l),class:"ml-2"},null,8,["modelValue"]),t(te,null,{default:s(()=>[t(b,{block:"",onClick:Ie,color:"rgb(47, 148, 172)",class:"mt-4"},{default:s(()=>e[29]||(e[29]=[c(" 取消 ")])),_:1}),t(b,{block:"",onClick:ke,disabled:!be.value,color:"rgb(47, 148, 172)",class:"mt-4 ml-2"},{default:s(()=>e[30]||(e[30]=[c(" 确认发布 ")])),_:1},8,["disabled"])]),_:1})]),_:1},8,["modelValue"]),t(R,{modelValue:N.value,"onUpdate:modelValue":e[17]||(e[17]=l=>N.value=l),title:"系统提示","ok-text":"🚀 确认发布","cancel-text":"暂不发布",onOk:we,onCancel:xe},{header:s(()=>[u("div",vl,[t(se,{name:"warning",color:"warning"}),e[31]||(e[31]=u("span",{class:"header-text"},"版本发布确认",-1))])]),default:s(()=>[u("div",gl,[u("p",Vl,[e[32]||(e[32]=c(" 即将为 ")),u("span",fl,V(ye(Y.value)),1),e[33]||(e[33]=c(" 系统发布版本：")),u("span",_l,V(X.value),1)]),t(Be),e[34]||(e[34]=u("p",{class:"confirm-text"},"该操作将立即生效且不可逆转，请确认是否继续？",-1))])]),_:1},8,["modelValue"]),t(R,{modelValue:U.value,"onUpdate:modelValue":e[18]||(e[18]=l=>U.value=l),title:"系统提示",size:"small",message:o.deleteConfirmMessage,onOk:ce,onCancel:pe,"ok-text":"确认","cancel-text":"取消","ok-props":{color:"danger"}},{header:s(()=>[u("div",bl,[t(se,{name:"warning",color:"warning"}),e[35]||(e[35]=u("span",{class:"header-text"},"确认删除？",-1))])]),_:1},8,["modelValue","message"]),t(ae,{modelValue:h.value,"onUpdate:modelValue":e[22]||(e[22]=l=>h.value=l),"hide-default-actions":"",size:"medium"},{header:s(()=>e[36]||(e[36]=[u("h5",{class:"va-h5"},"发布新通知",-1)])),default:s(()=>[u("div",yl,[t(m,{modelValue:w.value,"onUpdate:modelValue":e[19]||(e[19]=l=>w.value=l),label:"标题",placeholder:"请输入标题...",class:"mb-4","max-length":50,counter:""},{counter:s(({valueLength:l})=>[u("span",{class:W({"text-danger":l>50})},V(l)+"/50 ",3)]),_:1},8,["modelValue"]),t(m,{modelValue:k.value,"onUpdate:modelValue":e[20]||(e[20]=l=>k.value=l),label:"概述",placeholder:"请输入概述...",class:"mb-4","max-length":100,counter:""},{counter:s(({valueLength:l})=>[u("span",{class:W({"text-danger":l>100})},V(l)+"/100 ",3)]),_:1},8,["modelValue"]),t($e,{modelValue:x.value,"onUpdate:modelValue":e[21]||(e[21]=l=>x.value=l),label:"内容 (支持HTML语言)",placeholder:"请输入详细内容...",autosize:"","min-rows":10,"max-rows":20,"max-length":2e3,counter:"",class:"mb-6",style:{width:"1000px"}},{counter:s(({valueLength:l})=>[u("span",{class:W({"text-danger":l>2e3})},V(l)+"/2000 ",3)]),_:1},8,["modelValue"]),u("div",wl,[t(b,{color:"secondary",onClick:me},{default:s(()=>e[37]||(e[37]=[c(" 取消 ")])),_:1}),t(b,{disabled:!G,onClick:ie},{default:s(()=>e[38]||(e[38]=[c(" 提交 ")])),_:1},8,["disabled"])])])]),_:1},8,["modelValue"])]),u("div",kl,[t(Ee,{modelValue:A.value,"onUpdate:modelValue":[e[23]||(e[23]=l=>A.value=l),Ne],"page-size":C.pagesize,"visible-pages":"5",total:T.value,"buttons-preset":"secondary","boundary-numbers":""},null,8,["modelValue","page-size","total"]),u("span",xl," 共 "+V(T.value)+" 条记录 ",1)])]),_:1})}}},Il=el(Cl,[["__scopeId","data-v-2637f0af"]]);export{Il as default};
//# sourceMappingURL=notice-BQRfnzpB.js.map
